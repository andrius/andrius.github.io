<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title></title>
    <link>//andrius.mobi</link>
    <description>
      This blog explores the realm of real-time voice applications, covering topics such as Unified Communications, CTI, and call centers. It also discusses open-source VoIP solutions like Asterisk, Freeswitch, and Kamailio, highlighting their features and benefits. Additionally, the blog touches upon automations, integrations, test automation, and the scalability of containerized applications using Docker, along with DevOps practices.
    </description>
    
        
            <item>
                <title>Register SIP account and receive calls with Twilio</title>
                <link>//andrius.mobi/2023/07/register-sip-account-and-receive-calls-with-twilio.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>Living across three different countries necessitates maintaining local phone numbers in each for various purposes, including 2FA, e-signatures, and general communication. While I don’t use all SIM cards simultaneously, receiving calls on these numbers remains important.</p>

<p>Previously, I managed this with a self-hosted Asterisk PBX on a VPS. However, to reduce maintenance overhead, I decommissioned it and transitioned to Twilio for managing my Direct Inward Dialing (DID) numbers, which were originally sourced from various providers.</p>

<p>Twilio provides several methods for call handling, with TwiML (Twilio Markup Language) being a flexible option. This post details how to use TwiML to register a SIP softphone and receive inbound calls.</p>

<p><strong>Important Note on Regional POPs (Points of Presence):</strong>
As of July 2023, Twilio offers POPs in the EU (region <code class="language-plaintext highlighter-rouge">ie1</code>), USA (region <code class="language-plaintext highlighter-rouge">us1</code>), and Australia (region <code class="language-plaintext highlighter-rouge">au1</code>). My experience indicates that full feature support, particularly for certain SIP dialing scenarios within TwiML, might be more straightforward or consistently available with the US POP (<code class="language-plaintext highlighter-rouge">us1</code>). I encountered difficulties (specifically error “32002: Your TwiML tried to Dial a Twilio SIP Domain that can’t be found”) when attempting to use TwiML to dial a SIP endpoint registered in the EU zone (<code class="language-plaintext highlighter-rouge">ie1</code>) from a number also configured within the EU. If you have successfully configured such a scenario using an EU POP, please share your insights. For the purposes of this guide, focusing on the <code class="language-plaintext highlighter-rouge">us1</code> region for TwiML Bins and SIP domain configuration is recommended if you encounter similar issues.</p>

<p>Here are the steps to set up Twilio for SIP registration and inbound call handling:</p>

<ol>
  <li><strong>Create a SIP Credentials List:</strong> Navigate to <a href="https://console.twilio.com/us1/develop/voice/manage/cls">SIP Credentials Lists</a> in the Twilio console. Create a new list and add a username and password. This list will be used to authenticate your SIP softphone.</li>
  <li><strong>Create a SIP Domain:</strong> Go to <a href="https://console.twilio.com/us1/develop/voice/manage/sip-domains">SIP Domains</a>. Create a new SIP domain with a unique name (e.g., <code class="language-plaintext highlighter-rouge">yourusername.sip.twilio.com</code>). Enable SIP registration and associate the credentials list created in the previous step. Configure other settings like encryption as needed. <em>Ensure you are creating this in the desired region (e.g., <code class="language-plaintext highlighter-rouge">us1</code> for broader compatibility, or <code class="language-plaintext highlighter-rouge">ie1</code> if you are specifically targeting the EU and are aware of potential limitations).</em></li>
  <li><strong>Create a TwiML Bin:</strong> Go to <a href="https://console.twilio.com/us1/develop/twiml-bins/twiml-bins">TwiML Bins</a>. Create a new TwiML Bin with the following content. Replace <code class="language-plaintext highlighter-rouge">USERNAME</code> with the username from your credentials list and <code class="language-plaintext highlighter-rouge">YOURDOMAIN.sip.twilio.com</code> with your actual SIP domain. Adjust the <code class="language-plaintext highlighter-rouge">region</code> parameter in the <code class="language-plaintext highlighter-rouge">&lt;Sip&gt;</code> noun if necessary (e.g., to <code class="language-plaintext highlighter-rouge">us1</code> or <code class="language-plaintext highlighter-rouge">au1</code>).</li>
</ol>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;Response&gt;</span>
  <span class="c">&lt;!-- Say&gt;Hello from Twilio!&lt;/Say --&gt;</span>

  <span class="nt">&lt;Dial</span> <span class="na">answerOnBridge=</span><span class="s">"true"</span> <span class="na">sequential=</span><span class="s">"true"</span> <span class="na">ringTone=</span><span class="s">"lt"</span> <span class="na">record=</span><span class="s">"record-from-answer-dual"</span> <span class="na">trim=</span><span class="s">"trim-silence"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Sip&gt;</span>sip:USERNAME@YOURDOMAIN.sip.twilio.com;region=us1<span class="nt">&lt;/Sip&gt;</span> <span class="c">&lt;!-- Example using us1 region --&gt;</span>
  <span class="nt">&lt;/Dial&gt;</span>

  <span class="c">&lt;!-- Example of Simultaneous Dialing (Optional) --&gt;</span>
  <span class="c">&lt;!--
  &lt;Dial answerOnBridge="true" ringTone="es" record="record-from-answer-dual" trim="trim-silence"&gt;
    &lt;Sip&gt;sip:USERNAME@YOURDOMAIN.sip.twilio.com;region=us1&lt;/Sip&gt;
    &lt;Number&gt;+YOUR_OTHER_PHONE_NUMBER&lt;/Number&gt;
  &lt;/Dial&gt;
  --&gt;</span>

  <span class="nt">&lt;Say&gt;</span>Hello, the person you are trying to reach is unavailable. Please leave a message at the beep.<span class="nt">&lt;/Say&gt;</span>

  <span class="nt">&lt;Record</span> <span class="na">timeout=</span><span class="s">"30"</span> <span class="na">transcribe=</span><span class="s">"true"</span> <span class="na">playBeep=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;Hangup/&gt;</span>
<span class="nt">&lt;/Response&gt;</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*Note: The example above shows sequential dialing to one SIP endpoint. You can modify this for simultaneous dialing or other call flows. Ensure the SIP URI is correctly formatted (`sip:username@domain`).*
</code></pre></div></div>

<ol>
  <li><strong>Configure Phone Number:</strong> Purchase a DID number from <a href="https://console.twilio.com/us1/develop/phone-numbers/manage/incoming">Twilio Phone Numbers</a>. In the number’s configuration, under “A CALL COMES IN,” select “TwiML Bin” and choose the Bin you created.</li>
  <li><strong>Configure SIP Client:</strong> Download and configure a SIP client (e.g., Groundwire by Acrobits, Zoiper, Linphone). Use the username and password from your credentials list and your SIP domain (e.g., <code class="language-plaintext highlighter-rouge">YOURDOMAIN.sip.twilio.com</code>) for registration.</li>
  <li><strong>Test Inbound Calls:</strong> Make a test call to your Twilio DID number. If issues arise, check the <a href="https://console.twilio.com/us1/monitor/logs/debugger">Twilio Debugger logs</a> for errors.</li>
</ol>

<p>Once everything is set up and tested, you can redirect your existing mobile phone numbers to your new Twilio DID number using your mobile carrier’s call forwarding feature (e.g., by dialing <code class="language-plaintext highlighter-rouge">*21*+YOUR_TWILIO_NUMBER#</code> on your mobile phone, though the exact code may vary by carrier).</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2023/07/register-sip-account-and-receive-calls-with-twilio.html</guid>
                <description>
                    
                    How to register your SIP softphone and receive inbound calls using Twilio
                    
                </description>
                <pubDate>Sat, 08 Jul 2023 13:35:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Properly terminate crystal-lang service in docker</title>
                <link>//andrius.mobi/2019/11/properly-terminate-crystal-lang-service-in-docker.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>Production-ready Crystal-lang applications running in Docker containers must correctly process several signals to ensure proper shutdown. Docker provides two main commands to stop a running container: <code class="language-plaintext highlighter-rouge">docker stop</code> and <code class="language-plaintext highlighter-rouge">docker kill</code>. The <code class="language-plaintext highlighter-rouge">docker stop</code> command first sends a SIGTERM signal to the container’s main process, allowing it to perform a graceful shutdown. If the process does not terminate within a grace period, Docker then sends a SIGKILL signal to forcibly terminate it.</p>

<p>This article demonstrates how to handle SIGINT (Ctrl-C), SIGTERM, and SIGKILL signals within a Crystal-lang application.</p>

<h2 id="download-example-code">Download Example Code</h2>

<p>The example code is part of my sandbox repository and can be <a href="https://github.com/andrius/sandbox/tree/develop/crystal/signal_trap">downloaded here</a>.</p>

<p>If you are not familiar with Crystal-lang, the <a href="https://github.com/andrius/sandbox/blob/develop/crystal/signal_trap/src/signal_trap.cr">main file containing the business logic for this example is <code class="language-plaintext highlighter-rouge">src/signal_trap.cr</code></a>.</p>

<h2 id="installation">Installation</h2>

<p>The example is fully Dockerized. Ensure Docker is installed, then clone the Git repository.</p>

<h2 id="usage-instructions">Usage Instructions</h2>

<p>To run the application in development mode:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">--pull</span> <span class="nt">--force-rm</span> <span class="se">\</span>
  <span class="nt">-t</span> crystal-signal-trap <span class="se">\</span>
  <span class="nt">--file</span> ./Dockerfile <span class="nb">.</span> <span class="se">\</span>
<span class="o">&amp;&amp;</span> docker run <span class="nt">-ti</span> <span class="nt">--rm</span> <span class="nt">--name</span><span class="o">=</span><span class="nb">trap </span>crystal-signal-trap
</code></pre></div></div>

<p>More importantly, to test signal trapping in a production-like environment (using a minimal base image such as scratch, BusyBox, or Alpine), run the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build <span class="nt">--pull</span> <span class="nt">--force-rm</span> <span class="se">\</span>
  <span class="nt">-t</span> crystal-signal-trap <span class="se">\</span>
  <span class="nt">--file</span> ./Dockerfile-production <span class="nb">.</span> <span class="se">\</span>
<span class="o">&amp;&amp;</span> docker run <span class="nt">-ti</span> <span class="nt">--rm</span> <span class="nt">--name</span><span class="o">=</span><span class="nb">trap </span>crystal-signal-trap
</code></pre></div></div>

<h2 id="demo">Demo</h2>

<p><a href="https://asciinema.org/a/eIFSoH00QsLKpsfyypsL0i6cr"><img src="https://asciinema.org/a/eIFSoH00QsLKpsfyypsL0i6cr.svg" alt="asciicast" /></a></p>

<h2 id="processing-signals-individually">Processing Signals Individually</h2>

<p>Instead of grouping signal traps as demonstrated in the <a href="https://github.com/andrius/sandbox/blob/develop/crystal/signal_trap/src/signal_trap.cr#L9-L16">example application’s code</a>, it is possible to handle each signal separately:</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="no">Signal</span><span class="o">::</span><span class="no">INT</span><span class="p">.</span><span class="nf">trap</span> <span class="k">do</span>
   <span class="c1"># Processing SIGING</span>
 <span class="k">end</span>
</code></pre></div></div>

<h2 id="handling-other-signals">Handling Other Signals</h2>

<p>Docker allows sending various signals to containers:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker <span class="nb">kill</span> <span class="nt">--signal</span><span class="o">=</span>SIGHUP  my_container
</code></pre></div></div>

<p>In such cases, the Crystal-lang application should trap the specific signal, for example, <code class="language-plaintext highlighter-rouge">Signal::HUP.trap { ... }</code> for SIGHUP. A comprehensive <a href="https://crystal-lang.org/api/latest/Signal.html">list of signals known to Crystal-lang is available in the API documentation</a>.</p>

<hr />

<p>References:</p>

<ul>
  <li><a href="https://docs.docker.com/engine/reference/commandline/kill">docker kill command syntax</a>;</li>
  <li><a href="https://docs.docker.com/engine/reference/commandline/stop">docker stop command syntax</a>;</li>
  <li><a href="https://medium.com/@gchudnov/trapping-signals-in-docker-containers-7a57fdda7d86">Trapping signals in Docker containers</a>.</li>
</ul>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2019/11/properly-terminate-crystal-lang-service-in-docker.html</guid>
                <description>
                    
                    How to handle signals and properly terminate docker service written with the Crystal-lang.
                    
                </description>
                <pubDate>Sun, 03 Nov 2019 00:00:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Create the smallest Crystal-lang docker image based on scratch</title>
                <link>//andrius.mobi/2019/10/Create-the-smallest-Crystal-lang-docker-image-based-on-scratch.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>The official <a href="https://hub.docker.com/r/crystallang/crystal/tags">Crystal-lang Docker image</a> is Ubuntu-based and relatively large. However, production-ready images can be significantly smaller by utilizing Docker multi-stage builds. The smallest possible image can be created using the <a href="https://hub.docker.com/_/scratch">scratch</a> base image. If some pre-execution processing or shell utilities are needed, <a href="https://hub.docker.com/_/busybox">BusyBox</a> or <a href="https://hub.docker.com/_/alpine">Alpine Linux</a> are recommended alternatives.</p>

<h2 id="dockerfile-example">Dockerfile Example</h2>

<p>To create a minimal image, compile the application using the official Crystal-lang image in an initial stage, and then copy the resulting binary (and any necessary dynamic libraries) to a <code class="language-plaintext highlighter-rouge">scratch</code> image in a subsequent stage, as shown below:</p>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># vim:set ft=dockerfile:</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">crystallang/crystal:0.31.1</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>

<span class="k">LABEL</span><span class="s"> maintainer="Andrius Kairiukstis &lt;****&gt;"</span>

<span class="k">WORKDIR</span><span class="s"> /src</span>
<span class="k">COPY</span><span class="s"> . .</span>

<span class="k">RUN </span>shards build <span class="nt">--production</span> <span class="nt">--progress</span> <span class="nt">--verbose</span> <span class="nt">--warnings</span><span class="o">=</span>all
<span class="c"># Identify and copy runtime dependencies</span>
<span class="k">RUN </span>ldd ./bin/app | <span class="nb">tr</span> <span class="nt">-s</span> <span class="s1">'[:blank:]'</span> <span class="s1">'\n'</span> | <span class="nb">grep</span> <span class="s1">'^/'</span> | <span class="se">\
</span>    xargs <span class="nt">-I</span> % sh <span class="nt">-c</span> <span class="s1">'mkdir -p $(dirname deps%); cp -L % deps%;'</span> <span class="c"># Use -L to copy actual files for symlinks</span>
<span class="c"># RUN find ./deps/</span>

<span class="c">################################################################################</span>
<span class="c"># Final stage: copy artifacts to scratch image</span>
<span class="k">FROM</span><span class="s"> scratch</span>

<span class="k">LABEL</span><span class="s"> maintainer="Andrius Kairiukstis &lt;****&gt;"</span>

<span class="c"># Copy runtime dependencies. These are crucial for DNS resolution in Docker.</span>
<span class="k">COPY</span><span class="s"> --from=builder /src/deps/ /</span>
<span class="c"># Specifically copy DNS-related libraries if not covered by the general deps copy</span>
<span class="c"># Ensure these paths are correct for the builder image (crystallang/crystal:0.31.1)</span>
<span class="k">COPY</span><span class="s"> --from=builder /lib/x86_64-linux-gnu/libnss_dns.so.2 /lib/x86_64-linux-gnu/</span>
<span class="k">COPY</span><span class="s"> --from=builder /lib/x86_64-linux-gnu/libresolv.so.2 /lib/x86_64-linux-gnu/</span>

<span class="c"># Copy the compiled application</span>
<span class="k">COPY</span><span class="s"> --from=builder /src/bin/app /app</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["/app"]</span>
</code></pre></div></div>

<h2 id="crystal-lang-notes-on-dns-resolution">Crystal-lang Notes on DNS Resolution</h2>

<p>A common issue with minimal Crystal-lang Docker images (especially those based on <code class="language-plaintext highlighter-rouge">scratch</code>) is DNS resolution. This is documented in Crystal-lang GitHub issues such as <a href="https://github.com/crystal-lang/crystal/issues/2426">#2426</a> and <a href="https://github.com/crystal-lang/crystal/issues/6099">#6099</a>.
The most effective solution I’ve found involves copying necessary <code class="language-plaintext highlighter-rouge">libnss_*.so</code> and <code class="language-plaintext highlighter-rouge">libresolv.so</code> files from the builder image, as demonstrated in the Dockerfile above and discussed in <a href="https://gist.github.com/bcardiff/85ae47e66ff0df35a78697508fcb49af#gistcomment-2578255">this Gist comment</a>.</p>

<p>Attempting to compile with the <code class="language-plaintext highlighter-rouge">--static</code> flag, even when including these DNS libraries, did not consistently resolve DNS issues in my tests. Statically linked images without these libraries are generally only suitable for services that do not require external DNS lookups (e.g., purely listening services).</p>

<h2 id="resulting-image-sizes">Resulting Image Sizes</h2>

<p>The resulting image sizes are significantly reduced:</p>
<ul>
  <li><strong>scratch-based with ldd dependencies (DNS working):</strong> ~10MB</li>
  <li><strong>scratch-based, statically linked (DNS not working):</strong> ~6.25MB</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker image list dial_demo

# REPOSITORY             TAG                    IMAGE ID      CREATED         SIZE
# smallest-docker-image  scratch-ldd            d819bf2a43f3  21 minutes ago  10MB
# smallest-docker-image  scratch-static-no-dns  595afcfad6f0  13 minutes ago  6.25MB
</code></pre></div></div>

<h2 id="download-examples">Download Examples</h2>

<p>Example Dockerfiles demonstrating these techniques are available in my <a href="https://github.com/andrius/sandbox/tree/develop/crystal/smallest-docker-image">sandbox repository on GitHub</a>. This includes configurations for:</p>
<ul>
  <li><a href="https://github.com/andrius/sandbox/tree/develop/crystal/smallest-docker-image/scratch/ldd">scratch (ldd dependencies)</a> - ~10MB</li>
  <li><a href="https://github.com/andrius/sandbox/tree/develop/crystal/smallest-docker-image/busybox/ldd">BusyBox (ldd dependencies)</a> - ~11.2MB</li>
  <li><a href="https://github.com/andrius/sandbox/tree/develop/crystal/smallest-docker-image/alpine/ldd">Alpine Linux (ldd dependencies)</a> - ~15.6MB</li>
</ul>

<hr />

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2019/10/Create-the-smallest-Crystal-lang-docker-image-based-on-scratch.html</guid>
                <description>
                    
                    How to use docker multi-stage builds to create a smallest by size Crystal-lang docker image.
                    
                </description>
                <pubDate>Fri, 25 Oct 2019 00:00:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>All-in-one (Crystal-lang library that handle all the Asterisk PBX interfaces)</title>
                <link>//andrius.mobi/2019/10/all-in-one-asterisk-with-crystal.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>I have created and open-sourced a Crystal-lang shard (library) that supports all Asterisk PBX interfaces: Asterisk REST Interface (ARI), Asterisk Manager Interface (AMI), and all types of Asterisk Gateway Interface (AGI, FastAGI, AsyncAGI). You can find it on GitHub: <a href="https://github.com/ctiapps/asterisk">ctiapps/asterisk</a>.</p>

<h2 id="why-another-library">Why Another Library?</h2>

<p>At the time of development, there were no existing <a href="https://crystalshards.xyz/?filter=voip">Crystal-lang libraries for VoIP</a>, which prompted me to create this one.</p>

<p>In a recent project, we needed to work with both AMI and ARI concurrently, involving significant asynchronous processing. The initial codebase was Ruby-based; however, there was only a single Ruby gem available for ARI, and Ruby’s asynchronous support was not ideal for our needs.</p>

<p>I am a strong proponent of <a href="https://crystal-lang.org">Crystal-lang</a>. Its Ruby-inspired syntax made the transition smooth (though it’s important to note Crystal is not Ruby; only the syntax shares similarities). Crystal-lang is exceptionally fast, exhibiting no lags or delays. It compiles to a tiny binary, allowing for Docker images of around 20MB with all dependencies packed in. Before settling on Crystal, I also considered Elixir. Golang was another possibility, but I preferred to stay within a more familiar syntactic comfort zone after working with Ruby.</p>

<h2 id="whats-included">What’s Included?</h2>

<ul>
  <li>Support for all key Asterisk interfaces: ARI, AMI, AGI, FastAGI, and AsyncAGI.</li>
  <li><a href="https://github.com/ctiapps/asterisk/tree/develop/spec">Comprehensive test specs</a> that run against a live Asterisk PBX instance within Docker. These specs also serve as usage examples for the library. More detailed documentation is forthcoming.</li>
  <li><a href="https://ctiapps.github.io/asterisk">Official documentation</a>.</li>
</ul>

<hr />

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2019/10/all-in-one-asterisk-with-crystal.html</guid>
                <description>
                    
                    I&apos;ve created and open-sourced a Crystal-lang shard (library) that handles all Asterisk PBX interfaces (ARI, AMI, and all types of AGI).
                    
                </description>
                <pubDate>Wed, 23 Oct 2019 00:00:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>How to install software on firewalled server</title>
                <link>//andrius.mobi/2018/12/how-to-install-software-on-firewalled-server.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>This post outlines a method for installing software on a server with outbound firewall restrictions by using a reverse SSH proxy.</p>

<p><strong>Quick Summary:</strong></p>

<ol>
  <li><strong>Create a local SOCKS proxy:</strong> On your local machine, run <code class="language-plaintext highlighter-rouge">ssh -D 51010 localhost</code>. This creates a dynamic SOCKS proxy.</li>
  <li><strong>Forward the proxy to the remote server:</strong> SSH to the firewalled server using <code class="language-plaintext highlighter-rouge">ssh -R 51010:127.0.0.1:51010 firewalled-server</code>. This forwards your local SOCKS proxy to the remote machine, effectively creating a “poor man’s VPN.”</li>
  <li><strong>Install software via the proxy:</strong> Use a tool like <code class="language-plaintext highlighter-rouge">proxychains</code> or configure <code class="language-plaintext highlighter-rouge">apt.conf</code> to route traffic through the forwarded proxy.</li>
</ol>

<h2 id="preparation-steps">Preparation Steps</h2>

<ol>
  <li><strong>On your local (host) machine, open a terminal and establish a dynamic SOCKS proxy:</strong></li>
</ol>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ssh <span class="nt">-D</span> 51010 localhost
</code></pre></div></div>

<ol>
  <li><strong>In a new terminal tab on your local machine, SSH to the firewalled server, forwarding the local proxy port <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>:</strong></li>
</ol>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ssh <span class="nt">-R</span> 51010:127.0.0.1:51010 firewalled-server
</code></pre></div></div>

<ul>
  <li>
    <p>Check that everything works fine (I assume that curl is already installed):</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">ALL_PROXY</span><span class="o">=</span><span class="s2">"socks5://127.0.0.1:51010"</span> curl ifconfig.co
<span class="nv">ALL_PROXY</span><span class="o">=</span><span class="s2">"socks5h://127.0.0.1:51010"</span> curl ifconfig.co
</code></pre></div>    </div>

    <p>If both commands fail, check the <code class="language-plaintext highlighter-rouge">sshd</code> settings on the firewalled server (e.g., ensure <code class="language-plaintext highlighter-rouge">AllowTcpForwarding</code> is enabled). If only the first command (using <code class="language-plaintext highlighter-rouge">socks5://</code>) fails while the second (using <code class="language-plaintext highlighter-rouge">socks5h://</code>) succeeds, it indicates that DNS resolution is also likely firewalled, and <code class="language-plaintext highlighter-rouge">socks5h</code> (which proxies DNS requests) is necessary <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>.</p>
  </li>
</ul>

<p>You are now almost ready to install packages.</p>

<h2 id="installing-packages">Installing Packages</h2>

<p>Two primary options are available:</p>

<ol>
  <li><strong>Using <code class="language-plaintext highlighter-rouge">proxychains</code> to “socksify” <code class="language-plaintext highlighter-rouge">apt-get</code> <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>:</strong></li>
</ol>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  proxychains4 <span class="nt">-q</span> <span class="nt">-f</span> /home/user/.proxychains/proxychains.conf apt-get <span class="nt">-yqq</span> <span class="nb">install </span>ngrep sngrep
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*(Note: The `apt-get` command should typically be part of the `proxychains4` execution line, or `proxychains4` should be configured to automatically wrap subsequent commands if run interactively.)*
</code></pre></div></div>

<ol>
  <li>
    <p><strong>Configuring <code class="language-plaintext highlighter-rouge">apt</code> to use the SOCKS proxy via <code class="language-plaintext highlighter-rouge">apt.conf</code> <sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup>:</strong></p>

    <p>Create or update the proxy setting in <code class="language-plaintext highlighter-rouge">/etc/apt/apt.conf</code> or a file in <code class="language-plaintext highlighter-rouge">/etc/apt/apt.conf.d/</code>:</p>
  </li>
</ol>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">echo</span> <span class="s1">'Acquire::socks::Proxy "socks5h://127.0.0.1:51010/";'</span> <span class="se">\</span>
    <span class="o">&gt;&gt;</span> /etc/apt/apt.conf
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Then, install packages as usual with `apt-get`:
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  apt-get <span class="nt">-yqq</span> <span class="nb">install </span>ngrep sngrep
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Remember to comment out or remove the proxy directive in `apt.conf` after the installation is complete.)
</code></pre></div></div>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>For possible issues with <code class="language-plaintext highlighter-rouge">ssh -R</code>, see: <a href="https://serverfault.com/questions/595323/ssh-remote-port-forwarding-failed">Server Fault: SSH remote port forwarding failed</a>. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>For issues with <code class="language-plaintext highlighter-rouge">curl</code> and DNS resolution via proxy, check: <a href="https://unix.stackexchange.com/questions/175888/curl-7-27-any-proxy-set-curl-does-not-resolve-the-hostname-via-proxy">Unix Stack Exchange: curl &amp; SOCKS proxy DNS resolution</a>. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>To get <code class="language-plaintext highlighter-rouge">proxychains</code> on the remote host if it’s not installed: <code class="language-plaintext highlighter-rouge">proxychains4</code> has few dependencies (see <a href="https://packages.debian.org/buster/proxychains4">Debian packages for proxychains4</a>). If direct installation isn’t possible, you might need to <code class="language-plaintext highlighter-rouge">scp</code> the necessary <code class="language-plaintext highlighter-rouge">.deb</code> files (and their dependencies) and install them manually using <code class="language-plaintext highlighter-rouge">dpkg -i</code>. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p>For more <code class="language-plaintext highlighter-rouge">apt.conf</code> proxy options, see: <a href="https://askubuntu.com/questions/35223/syntax-for-socks-proxy-in-apt-conf">Ask Ubuntu: Syntax for SOCKS proxy in apt.conf</a>. <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/12/how-to-install-software-on-firewalled-server.html</guid>
                <description>
                    
                    How to use a reverse SSH proxy to install software on a server with outbound firewalls (gray zone ;) )
                    
                </description>
                <pubDate>Thu, 27 Dec 2018 00:00:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>DigitalOcean, Floating IP and VoIP</title>
                <link>//andrius.mobi/2018/12/digital-ocean-floating-ip-and-voip.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>DigitalOcean introduced <a href="https://www.digitalocean.com/docs/networking/floating-ips/overview/">Floating IPs</a> in 2015 (<a href="https://m.do.co/c/492078597684">here is a referral link for $100 credit</a>), but I had not previously used them with VoIP. This post details my experience configuring a Floating IP for VoIP, specifically with Asterisk.</p>

<p>(Note: At the time of publishing, all IP addresses mentioned were released, and associated data was removed.)</p>

<h2 id="droplet-and-floating-ip-configuration">Droplet and Floating IP Configuration</h2>
<p>A Floating IP, <code class="language-plaintext highlighter-rouge">206.189.246.114</code>, was assigned via the DigitalOcean console to a newly created Debian Linux Droplet. The IP addresses of the test Droplet were:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@test:~# /sbin/ifconfig | <span class="nb">grep</span> <span class="nt">-B</span> 1 <span class="s1">'inet '</span>

eth0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 206.189.20.174  netmask 255.255.240.0  broadcast 206.189.31.255
<span class="nt">--</span>
eth0:1: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 10.16.0.5  netmask 255.255.0.0  broadcast 10.16.255.255
</code></pre></div></div>

<h2 id="sip-configuration">SIP Configuration</h2>
<p>For testing purposes, I installed Asterisk from the OS repository (<code class="language-plaintext highlighter-rouge">apt-get install -yqq asterisk</code>) and configured a SIP client to register to the Floating IP <code class="language-plaintext highlighter-rouge">206.189.246.114</code>. As expected, this initial attempt was unsuccessful, with SIP packets not flowing correctly:</p>

<p><img src="/images/floating-ip/1-failure.png" alt="SIP registration failure with basic setup" /></p>

<p>Next, I updated <code class="language-plaintext highlighter-rouge">sip.conf</code> with typical settings for Asterisk behind NAT, utilizing <code class="language-plaintext highlighter-rouge">externip</code> (as described in the default <code class="language-plaintext highlighter-rouge">sip.conf</code> comments regarding <code class="language-plaintext highlighter-rouge">externip</code>, <code class="language-plaintext highlighter-rouge">externhost</code>, and <code class="language-plaintext highlighter-rouge">externaddr</code>):</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">externip</span><span class="p">=</span><span class="s">206.189.246.114</span>
<span class="py">nat</span><span class="p">=</span><span class="s">force_rport,comedia</span>
</code></pre></div></div>

<p>This yielded inconsistent results; in most cases, SIP registration still failed.</p>

<p><img src="/images/floating-ip/2-ok-but.png" alt="Inconsistent SIP registration with externip" /></p>

<p>A quick investigation of the SIP dump (revealing a third IP address) led me to change the SIP bind address in <code class="language-plaintext highlighter-rouge">sip.conf</code> to the Droplet’s private IP:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">udpbindaddr</span><span class="p">=</span><span class="s">10.16.0.5</span>
<span class="py">tcpenable</span><span class="p">=</span><span class="s">yes</span>
<span class="py">tcpbindaddr</span><span class="p">=</span><span class="s">10.16.0.5</span>
<span class="c">; ...
</span><span class="py">externip</span><span class="p">=</span><span class="s">206.189.246.114</span>
<span class="py">nat</span><span class="p">=</span><span class="s">force_rport,comedia</span>
</code></pre></div></div>

<p>Now, SIP registration and calls function correctly.</p>

<p><img src="/images/floating-ip/3-ok.png" alt="Successful SIP registration with private IP binding" /></p>

<p>Calls are also working as expected:</p>

<p><img src="/images/floating-ip/4-call-ok.png" alt="Successful call with private IP binding" /></p>

<h2 id="docker-setup">Docker Setup</h2>
<p>Let’s attempt to achieve the same result using Docker.</p>

<p>The configuration works if Asterisk inside the Docker container can bind to the same private IP address to which the Floating IP is pointed. This requires running the container with the <code class="language-plaintext highlighter-rouge">--net=host</code> option:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run <span class="nt">-ti</span> <span class="nt">--rm</span> <span class="se">\</span>
  <span class="nt">--net</span><span class="o">=</span>host <span class="se">\</span>
  <span class="nt">--name</span> asterisk <span class="se">\</span>
  <span class="nt">-v</span> /etc/asterisk/sip.conf:/etc/asterisk/sip.conf <span class="se">\</span>
  andrius/asterisk <span class="se">\</span>
  asterisk <span class="nt">-vvvddddc</span>
</code></pre></div></div>

<p>Technically, this is sufficient for many use cases. However, an Asterisk container configured this way does not integrate well into a <code class="language-plaintext highlighter-rouge">docker-compose</code> development environment, as other containers will not be able to “see” it through Docker’s network bridging. I plan to investigate this further. Perhaps passing the <code class="language-plaintext highlighter-rouge">NET_ADMIN</code> capability or running the container in privileged mode would allow for the necessary <code class="language-plaintext highlighter-rouge">iptables</code> manipulations to resolve this.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/12/digital-ocean-floating-ip-and-voip.html</guid>
                <description>
                    
                    How to configure DigitalOcean&apos;s floating IP with VoIP, specifically with Asterisk, using Docker.
                    
                </description>
                <pubDate>Tue, 18 Dec 2018 00:00:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Tiny docker image with ngrok</title>
                <link>//andrius.mobi/2018/12/tiny-docker-image-with-ngrok.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>I discovered an excellent, tiny Docker image for ngrok: <code class="language-plaintext highlighter-rouge">wernight/ngrok</code>. I am now using it to expose this blog locally during development.</p>

<p>You can find the image on <a href="https://hub.docker.com/r/wernight/ngrok">Docker Hub</a> and its source on <a href="https://github.com/wernight/docker-ngrok">GitHub</a> (assuming the GitHub link was intended to be the source, if it’s just a mirror of Docker Hub, the Docker Hub link is primary).</p>

<p>Here are some handy snippets for interacting with the ngrok container. Note that while <code class="language-plaintext highlighter-rouge">docker-compose port ngrok 4040</code> can be used to get the port for API calls (e.g., <code class="language-plaintext highlighter-rouge">curl $(docker-compose port ngrok 4040)/api/tunnels</code>), I use <code class="language-plaintext highlighter-rouge">$(docker ps -l -q --filter "name=blog_ngrok")</code> to identify the container ID. This approach works with both <code class="language-plaintext highlighter-rouge">docker-compose up/run</code> and direct <code class="language-plaintext highlighter-rouge">docker</code> commands.</p>

<ul>
  <li><strong>View Logs:</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">BLOG</span><span class="o">=</span><span class="si">$(</span>docker ps <span class="nt">-l</span> <span class="nt">-q</span> <span class="nt">--filter</span> <span class="s2">"name=blog_ngrok"</span><span class="si">)</span>
docker logs <span class="nt">-f</span> <span class="nv">$BLOG</span>
</code></pre></div></div>

<ul>
  <li><strong>Check Open ngrok Tunnels:</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">BLOG</span><span class="o">=</span><span class="si">$(</span>docker ps <span class="nt">-l</span> <span class="nt">-q</span> <span class="nt">--filter</span> <span class="s2">"name=blog_ngrok"</span><span class="si">)</span>
curl <span class="si">$(</span>docker port <span class="nv">$BLOG</span> 4040<span class="si">)</span>/api/tunnels
</code></pre></div></div>

<ul>
  <li><strong>Open Browser with ngrok HTTP Console:</strong></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">BLOG</span><span class="o">=</span><span class="si">$(</span>docker ps <span class="nt">-l</span> <span class="nt">-q</span> <span class="nt">--filter</span> <span class="s2">"name=blog_ngrok"</span><span class="si">)</span>
open http://<span class="si">$(</span>docker port <span class="nv">$BLOG</span> 4040<span class="si">)</span>
</code></pre></div></div>

<p>This is how the <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file looks for this Jekyll site, incorporating the ngrok service:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '3'

volumes:
  ruby-cache:
    driver: local

services:
  build:
    image: jekyll/jekyll
    volumes:
      - ruby-cache:/usr/local/bundle
      - ./:/srv/jekyll
    command: jekyll build

  jekyll:
    image: jekyll/jekyll
    volumes:
      - ruby-cache:/usr/local/bundle
      - ./:/srv/jekyll
    command: jekyll serve --incremental --watch
    ports:
      - 127.0.0.1:4000:4000

  ngrok:
    image: wernight/ngrok
    links:
      - jekyll
    stdin_open: true
    tty: true
    ports:
      - 127.0.0.1:4040:4040
    environment:
      - NGROK_REGION=eu
      - NGROK_AUTH=...
      - NGROK_SUBDOMAIN=...
      - NGROK_PROTOCOL=http
      - NGROK_PORT=jekyll:4000
</code></pre></div></div>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2018/12/tiny-docker-image-with-ngrok.html</guid>
                <description>
                    
                    I&apos;ve found an excellent tiny Docker image for ngrok (wernight/ngrok). From now just using it to handle this blog.
                    
                </description>
                <pubDate>Mon, 17 Dec 2018 00:00:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Updated OPUS codec patch that supports Asterisk 11.11.0 and 12.2.5</title>
                <link>//andrius.mobi/2014/08/asterisk-opus-patch-for-11110.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>I have updated the OPUS codec patch, which now supports Asterisk 11.11.0 and 12.2.5. I have tested it with VP8 in pass-through mode, and it functions correctly. You can download the patch <a href="https://github.com/andrius/asterisk-opus">here</a>.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2014/08/asterisk-opus-patch-for-11110.html</guid>
                <description>
                    
                </description>
                <pubDate>Fri, 08 Aug 2014 10:07:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>WebRTC with Asterisk 11?</title>
                <link>//andrius.mobi/2013/07/webrtc-with-asterisk-11.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>I recently tested two WebRTC clients, <a href="http://jssip.net/">JsSIP</a> and <a href="http://sipml5.org/">sipML5</a>, with Asterisk 11. Both clients successfully completed echo tests using the ulaw (g711u) codec. However, calls initiated from a WebRTC client to a SIP softphone resulted in one-way audio.</p>

<p>For WebRTC configuration, I referred to the following Asterisk wiki articles:</p>
<ul>
  <li><a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk+WebRTC+Support">Asterisk WebRTC Support</a></li>
  <li><a href="https://wiki.asterisk.org/wiki/display/AST/WebRTC+tutorial+using+SIPML5">WebRTC tutorial using SIPML5</a></li>
</ul>

<p>I’m excited about the potential of WebRTC with Asterisk!</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/07/webrtc-with-asterisk-11.html</guid>
                <description>
                    
                    Tonight, I tried two WebRTC clients (JsSIP and sipML5) with Asterisk 11. I was able to get both of them working for echo test calls with the ulaw (g711u) codec. However, when I called from WebRTC to the SIP softphone, there was only one-way audio.
                    
                </description>
                <pubDate>Thu, 11 Jul 2013 11:38:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Roaming PBX update</title>
                <link>//andrius.mobi/2013/05/roaming-pbx-update.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>New features in this update:</p>

<ul>
  <li>Asterisk 11.4</li>
  <li>SILK codec</li>
  <li>Watchdog implementation to improve Raspberry Pi board performance and prevent deadlocks.</li>
</ul>

<p><strong>Download link:</strong> <a href="https://j.mp/tinypbx">j.mp/tinypbx</a>
<strong>Image name for this release:</strong> <code class="language-plaintext highlighter-rouge">raspbian_basic_wheezy_20130523.img.gz</code></p>

<p><strong>Credentials:</strong></p>
<ul>
  <li>SSH (port 22)</li>
  <li>Username: <code class="language-plaintext highlighter-rouge">root</code></li>
  <li>Password: <code class="language-plaintext highlighter-rouge">raspberry</code></li>
</ul>

<p>Remember to update passwords after flashing and the first boot!</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/05/roaming-pbx-update.html</guid>
                <description>
                    
                    What&apos;s new: Asterisk 11.4,  SILK codec,  watchdog to improve Raspberry Pi board performance and prevent deadlocks.
                    
                </description>
                <pubDate>Thu, 23 May 2013 23:30:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>First release of Roaming PBX</title>
                <link>//andrius.mobi/2013/05/roaming-pbx-first-release.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>Today, I have created the latest image for the Roaming PBX project. This alpha release includes Ruby, pcapsipdump, Asterisk PBX, and the SILK codec, and it is now ready for testing. You can download the image from this <a href="https://j.mp/tinypbx">link</a>.</p>

<p>To flash the image onto a Raspberry Pi, follow the standard instructions: decompress the <code class="language-plaintext highlighter-rouge">.gz</code> file, insert the SD card, and use the Linux <code class="language-plaintext highlighter-rouge">dd</code> command to write the image. For a detailed guide on flashing, you can refer to <a href="http://www.andrewmunsell.com/blog/getting-started-raspberry-pi-install-raspbian/">this site</a>.</p>

<p>The <a href="https://github.com/andrius/build-raspbian-image">Git repository containing the script</a> for creating RPI images has been updated. I plan to write a separate post with a more detailed description of this script. In summary, the installer creates a minimal Raspbian image and, at the end of the process, mounts a “delivery” folder to the target image and executes the <code class="language-plaintext highlighter-rouge">install.sh</code> bash script (a sample of which can be found in the Git repository).</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/05/roaming-pbx-first-release.html</guid>
                <description>
                    
                    Announcing the first alpha release of the Roaming PBX image, featuring Ruby, pcapsipdump, Asterisk PBX, and the SILK codec.
                    
                </description>
                <pubDate>Tue, 07 May 2013 21:32:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Creating your own custom image for Raspberry Pi</title>
                <link>//andrius.mobi/2013/04/creating-own-image-for-raspberry-pi.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>To facilitate a cross-compile environment for Raspberry Pi images, I created an image builder project: <a href="https://github.com/andrius/build-raspbian-image">build-raspbian-image on GitHub</a>.</p>

<p>This project is based on a <a href="https://blog.kmp.or.at/build-your-own-raspberry-pi-image/">blog post and code by Klaus Maria Pfeiffer</a>.</p>

<p>The code functions correctly on Debian (tested with CrunchBangLinux) and Ubuntu.</p>

<p>Instructions:</p>

<ol>
  <li>Clone the repository: <code class="language-plaintext highlighter-rouge">git clone https://github.com/andrius/build-raspbian-image.git</code></li>
  <li>Navigate into the cloned directory. Review the content and install necessary packages, or execute the <code class="language-plaintext highlighter-rouge">./install.sh</code> script.</li>
  <li>Run <code class="language-plaintext highlighter-rouge">./raspbian/build_raspbian_sd_card.sh</code>. The resulting <code class="language-plaintext highlighter-rouge">.img</code> file will be located in the <code class="language-plaintext highlighter-rouge">/tmp/rpi</code> folder.</li>
</ol>

<p>The main challenge currently lies with the cross-compilation environment. Due to time constraints, the process is not fully automated. During cross-compilation, manual intervention is required:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"Execute all necessary commands, then type exit"</span>
<span class="nb">echo</span> <span class="s2">"Asterisk install files are located at /usr/src/asterisk"</span>
bash
</code></pre></div></div>

<h2 id="update">Update</h2>
<p>The GitHub repository has been updated. The installation script now mounts a <code class="language-plaintext highlighter-rouge">delivery</code> folder to the target RPI image and executes an <code class="language-plaintext highlighter-rouge">install.sh</code> script located within that mounted folder. This allows for custom build scripts or manual command-line access via <code class="language-plaintext highlighter-rouge">bash</code> during RPI image creation.</p>

<p>An example image created with this process, featuring Ruby 2.0 and Asterisk PBX, is available.</p>

<p>Download link for the latest TinyPBX image: <a href="http://j.mp/tinypbx">j.mp/tinypbx</a>.</p>

<p>Standard Raspberry Pi flashing instructions apply (a good guide can be found at <a href="http://www.andrewmunsell.com/blog/getting-started-raspberry-pi-install-raspbian/">this site describing the flashing procedure</a>):</p>

<ul>
  <li>Decompress the <code class="language-plaintext highlighter-rouge">.gz</code> file.</li>
  <li>Insert the SD card.</li>
  <li>Flash the image using the Linux <code class="language-plaintext highlighter-rouge">dd</code> command.</li>
</ul>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/04/creating-own-image-for-raspberry-pi.html</guid>
                <description>
                    
                    How to cross-compile a custom Raspberry Pi image and to build custom Asterisk PBX installation.
                    
                </description>
                <pubDate>Thu, 25 Apr 2013 21:59:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>SIP TCP vs UDP with mobile client: awesome results</title>
                <link>//andrius.mobi/2013/04/perfect-results-sip-tcp-vs-udp.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>While it is generally known that TCP can be more battery-efficient for mobile VoIP compared to UDP, the extent of this improvement can be surprising. After switching my Android softphone (Bria) from UDP to TCP yesterday, I observed a significant difference. Typically, by 2:20 PM, my mobile phone battery would be around 50%; however, with TCP, it is now at 88%.</p>

<p>Regarding voice quality, I have not noticed any discernible difference between the two protocols.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/04/perfect-results-sip-tcp-vs-udp.html</guid>
                <description>
                    
                </description>
                <pubDate>Tue, 02 Apr 2013 12:24:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Raspberry Pi: how to create your own image</title>
                <link>//andrius.mobi/2013/03/raspberry-pi-how-to-create-own-image.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>I am currently developing a custom Roaming VoIP PBX as a Raspberry Pi image, which requires frequent rebuilding of project packages. Compiling packages directly on the Raspberry Pi is not ideal as it can take several hours. Therefore, I was looking for a tool to create the base image on a more powerful machine, such as my laptop or a VPS.</p>

<p>A good starting point is <a href="http://blog.kmp.or.at/2012/05/build-your-own-raspberry-pi-image/">this blog post on building your own Raspberry Pi image</a>. It includes a <a href="http://www.kmp.or.at/~klaus/raspberry/build_rpi_sd_card.sh">shell script for building the image</a> (right-click and select ‘download as’).</p>

<p>Here are some useful links regarding cross-compilation and QEMU (for emulating and compiling in a Raspberry Pi environment):</p>

<ul>
  <li><a href="http://ffmpeg.org/trac/ffmpeg/wiki/How%20to%20compile%20FFmpeg%20for%20Raspberry%20Pi%20(Raspbian)">How to compile FFmpeg for Raspberry Pi (Raspbian)</a></li>
  <li><a href="http://www.raspbian.org/RaspbianDocumentation">Raspbian Documentation</a></li>
  <li><a href="http://hertaville.com/2012/09/28/development-environment-raspberry-pi-cross-compiler/">Development Environment Raspberry Pi Cross-Compiler</a></li>
  <li><a href="http://www.raspberrypiforums.com/forums/tutorials/article/16-a-raspberry-pi-emulated-environment-on-osx-lion/">A Raspberry Pi emulated environment on OS X Lion</a></li>
  <li><a href="http://xecdesign.com/qemu-emulating-raspberry-pi-the-easy-way/">QEMU Emulating Raspberry Pi The Easy Way</a></li>
  <li><a href="http://www.raspberrypi.org/phpBB3/viewtopic.php?f=29&amp;t=37386">Raspberry Pi Forum Discussion on QEMU</a></li>
  <li><a href="http://igor.gold.ac.uk/~mas01mjy/wp/?p=95">Blog post on Raspberry Pi QEMU Emulation</a></li>
  <li><a href="http://elinux.org/Rpi_kernel_compilation#Cross_compiling_from_OSX">RPi Kernel Compilation (Cross compiling from OSX)</a></li>
</ul>

<h2 id="update-may-2013">Update (May 2013)</h2>

<p>Sometime ago, I created a repository with helper scripts: <a href="https://github.com/andrius/build-raspbian-image">https://github.com/andrius/build-raspbian-image</a>. Feel free to check it out!</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/03/raspberry-pi-how-to-create-own-image.html</guid>
                <description>
                    
                    Currently I do developing my own Roaming VoIP PBX as a Raspberry Pi image, and have to rebuild project packages often. It is not best idea to compile packages right on Raspberry Pi. That would take hours. I was searching for a tool that can create image base - on my laptop or VPS.
                    
                </description>
                <pubDate>Fri, 22 Mar 2013 08:24:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Asterisk with silk8 and amr-nb codecs</title>
                <link>//andrius.mobi/2013/03/asterisk-with-silk8-and-amr-nb-codecs.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>As part of a lab project (Roaming PBX), I have compiled SILK and AMR codecs for Asterisk. The AMR codec compilation was based on online research, while SILK was compiled following the instructions in <a href="https://github.com/mordak/codec_silk">this repository</a>.</p>

<h2 id="update-march-20-2013">Update (March 20, 2013)</h2>
<p>I tested SILK8 (SILK-NB) on Android devices using CSIPSimple and Bria. The performance was not optimal, and the quality was definitely not fantastic. This was true for both my self-compiled version and the official Digium SILK codec.</p>

<p>Currently testing AMR-NB.</p>

<h2 id="update-2-march-21-2013">Update #2 (March 21, 2013)</h2>
<p>SILK8 performance with Bria on Android is acceptable after modifying <code class="language-plaintext highlighter-rouge">codecs.conf</code> with the following settings:</p>

<pre><code class="language-cfg">[silk8]
type=silk
samprate=8000
fec=true
packetloss_percentage=10
maxbitrate=20000 ; Default value was 10000
dtx=false        ; Encode using discontinuous transmission mode or not. Turning this
                 ; on will save bandwidth during periods of silence at the cost of
                 ; increased computational complexity. Off by default.
</code></pre>

<p>I encountered some minor issues with AMR-NB and will post an update later.</p>

<h3 id="update-3-april-15-2013">Update #3 (April 15, 2013)</h3>
<p>AMR-NB performs significantly better. I plan to describe the installation steps in a separate post. The quality is amazing, and the bandwidth consumption is very low. Unfortunately, due to licensing issues, AMR-NB cannot be included as part of the official Asterisk distribution.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/03/asterisk-with-silk8-and-amr-nb-codecs.html</guid>
                <description>
                    
                    How to get Asterisk PBX working with SILK and AMR-NB codecs.
                    
                </description>
                <pubDate>Mon, 18 Mar 2013 23:11:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Debian installer (Asterisk and Adhearsion AGI framework)</title>
                <link>//andrius.mobi/2013/03/debian-installer-asterisk-and-agi.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>This script installs Asterisk PBX 11.x, including support for fax, MySQL, Ruby, and the Adhearsion AGI framework. Please run this script as root. If ImageMagick is not required, the section that downloads and installs it can be removed.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Function to generate a random password.</span>
<span class="c"># Input: $1 (optional) - desired password length (default: 20).</span>
genpasswd<span class="o">()</span> <span class="o">{</span>
  <span class="nb">local </span><span class="nv">l</span><span class="o">=</span><span class="nv">$1</span>
  <span class="o">[</span> <span class="s2">"</span><span class="nv">$l</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">""</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">l</span><span class="o">=</span>20
  <span class="nb">tr</span> <span class="nt">-dc</span> A-Za-z0-9_ &lt; /dev/urandom | <span class="nb">head</span> <span class="nt">-c</span> <span class="k">${</span><span class="nv">l</span><span class="k">}</span> | xargs
<span class="o">}</span>

<span class="c"># MySQL default root password. This can be replaced with a static password string.</span>
<span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span><span class="sb">`</span>genpasswd 16<span class="sb">`</span> <span class="c"># can be replaced by static text password</span>

<span class="c"># To remove MySQL completely, execute the following commands (copy-paste to shell):</span>
<span class="c"># M=`dpkg -l|grep mysql|awk '{print $2}'|xargs`;apt-get -y purge ${M};rm -rf /etc/mysql;rm -rf /var/lib/mysql</span>

<span class="nv">MYSQL_SERVER_VERSION</span><span class="o">=</span><span class="sb">`</span>apt-cache showpkg mysql-server|grep <span class="s2">"Versions:"</span> <span class="nt">-A</span> 1|tail <span class="nt">--lines</span> 1|awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="c"># tell installer about pre-set MySQL server password</span>
<span class="nb">echo</span> <span class="s2">"mysql-server-</span><span class="k">${</span><span class="nv">MYSQL_SERVER_VERSION</span><span class="k">}</span><span class="s2"> mysql-server/root_password password </span><span class="k">${</span><span class="nv">MYSQL_ROOT_PASSWORD</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  | debconf-set-selections
<span class="nb">echo</span> <span class="s2">"mysql-server-</span><span class="k">${</span><span class="nv">MYSQL_SERVER_VERSION</span><span class="k">}</span><span class="s2"> mysql-server/root_password_again password </span><span class="k">${</span><span class="nv">MYSQL_ROOT_PASSWORD</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  | debconf-set-selections

<span class="c"># install necessary packages</span>
apt-get update
apt-get upgrade
apt-get <span class="nt">-y</span> <span class="nb">install </span>build-essential linux-headers-<span class="sb">`</span><span class="nb">uname</span> <span class="nt">-r</span><span class="sb">`</span> libxml2-dev libncurses-dev libnewt-dev <span class="se">\</span>
  openssl libreadline6 libreadline-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev <span class="se">\</span>
  libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison libtiff-dev <span class="se">\</span>
  libjpeg-progs libjpeg-dev libpng-dev mysql-server libmysqlclient-dev sqlite3 libsqlite3-dev <span class="se">\</span>
  wget rsync subversion

<span class="c"># create /usr/src if not exists</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> /usr/src
<span class="nb">cd</span> /usr/src

<span class="c"># download SpanDSP (need to support faxing)</span>
wget <span class="nt">--continue</span> http://soft-switch.org/downloads/spandsp/spandsp-0.0.6pre21.tgz

<span class="c"># download imagemagick (need to convert faxes)</span>
wget <span class="nt">--continue</span> http://www.imagemagick.org/download/ImageMagick-6.8.3-9.tar.gz

<span class="c"># download asterisk PBX</span>
wget <span class="nt">--continue</span> http://downloads.asterisk.org/pub/telephony/asterisk/asterisk-11.2.1.tar.gz

<span class="c"># unpack downloaded packages</span>
<span class="nb">tar</span> <span class="nt">-zxf</span> spandsp-0.0.6pre21.tgz
<span class="nb">tar</span> <span class="nt">-zxf</span> ImageMagick-6.8.3-9.tar.gz
<span class="nb">tar</span> <span class="nt">-zxf</span> asterisk-11.2.1.tar.gz

<span class="c"># download asterisk add-ons</span>
<span class="nb">cd </span>asterisk-11.2.1
./contrib/scripts/get_ilbc_source.sh
./contrib/scripts/get_mp3_source.sh

<span class="c"># install imagemagick</span>
<span class="nb">cd</span> ../ImageMagick-6.8.3-9
./configure <span class="o">&amp;&amp;</span> make all <span class="o">&amp;&amp;</span> make <span class="nb">install</span>

<span class="c"># install spandsp</span>
<span class="nb">cd</span> ../spandsp-0.0.6
./configure <span class="o">&amp;&amp;</span> make all <span class="o">&amp;&amp;</span> make <span class="nb">install</span>

<span class="c"># install asterisk PBX</span>
<span class="nb">cd</span> ../asterisk-11.2.1
./configure <span class="o">&amp;&amp;</span> make all <span class="o">&amp;&amp;</span> make <span class="nb">install</span> <span class="o">&amp;&amp;</span> make samples <span class="o">&amp;&amp;</span> make config <span class="o">&amp;&amp;</span> make install-logrotate

<span class="c"># install asterisk utilities</span>
<span class="nb">cp</span> ./contrib/scripts/astcli /usr/local/bin/

<span class="c"># Automate asterisk service to run on startup.</span>
update-rc.d asterisk defaults

<span class="c"># install rvm and ruby</span>
curl <span class="nt">-L</span> get.rvm.io | bash <span class="nt">-s</span> stable
<span class="c"># to remove rvm do:</span>
<span class="c"># rvm implode</span>
<span class="nb">source</span> /etc/profile.d/rvm.sh
ldconfig
rvm <span class="nb">install </span>1.9.3
gem <span class="nb">install</span> <span class="nt">--no-rdoc</span> <span class="nt">--no-ri</span> bundler sqlite3 mysql <span class="se">\</span>
  adhearsion adhearsion-activerecord adhearsion-asterisk adhearsion-drb adhearsion-rails adhearsion-xmpp

<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n\n\n\n</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"**************************************************************************************"</span>
<span class="nb">echo</span> <span class="s2">"  INSTALLATION DONE"</span>
<span class="nb">echo</span> <span class="s2">"  YOUR ROOT MYSQL PASSWORD IS </span><span class="k">${</span><span class="nv">MYSQL_ROOT_PASSWORD</span><span class="k">}</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"  SAVE IT IN SAFE PLACE :)"</span>
<span class="nb">echo</span> <span class="s2">"**************************************************************************************"</span>
</code></pre></div></div>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/03/debian-installer-asterisk-and-agi.html</guid>
                <description>
                    
                    Here is a script that installs Asterisk PBX 11.x: with fax support, MySQL, Ruby, and Adhearsion AGI.
                    
                </description>
                <pubDate>Thu, 14 Mar 2013 23:23:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Roaming PBX with Raspberry Pi, Asterisk and chan_dongle</title>
                <link>//andrius.mobi/2013/03/roaming-solution-based-on-raspberry-pi-asterisk-chan_dongle.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>As a frequent traveler, I recognize the telecommunication needs of fellow travelers and global citizens. Consequently, I have decided to dedicate my free time to developing a Roaming PBX solution.</p>

<p>My plan includes the following:</p>

<ul>
  <li>Create a Raspberry Pi image, potentially incorporating an OpenWRT solution.</li>
  <li>Set up Asterisk PBX.</li>
  <li>Install <code class="language-plaintext highlighter-rouge">chan_dongle</code>, an Asterisk driver for Huawei USB modems, to handle two-way GSM calls.</li>
  <li>Implement VPN functionality to bypass VoIP blocking in certain locations.</li>
  <li>Utilize the FreePBX GUI for managing dial plans.</li>
  <li>Configure Asterisk2billing for expense tracking.</li>
  <li>Develop keep-alive scripts for system monitoring.</li>
</ul>

<p>Are there any other features to consider?</p>

<h3 id="update-march-19-2013">Update (March 19, 2013)</h3>

<p>I have successfully created an image file based on standard Raspbian. Currently, I am working on a cross-compiler.</p>

<h3 id="update-2-may-6-2013">Update #2 (May 6, 2013)</h3>

<p>For those interested, the latest image can be downloaded from: <a href="http://j.mp/tinypbx">http://j.mp/tinypbx</a>.
Standard flashing instructions apply: decompress the <code class="language-plaintext highlighter-rouge">.gz</code> file, insert the SD card, and use the Linux <code class="language-plaintext highlighter-rouge">dd</code> command to flash the image. Detailed instructions for flashing can be found at resources like <a href="http://www.andrewmunsell.com/blog/getting-started-raspberry-pi-install-raspbian/">this guide on installing Raspbian</a>.</p>

<p>Additionally, I have initiated a side project for cross-compiling and building custom images, available at: <a href="https://github.com/andrius/build-raspbian-image">https://github.com/andrius/build-raspbian-image</a>.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/03/roaming-solution-based-on-raspberry-pi-asterisk-chan_dongle.html</guid>
                <description>
                    
                    As a frequent traveler, I understand the telecommunications needs of other travelers and citizens of the world. Recently, I decided to dedicate my free time to building a Roaming PBX solution.
                    
                </description>
                <pubDate>Tue, 12 Mar 2013 21:28:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Why you should create AGI?</title>
                <link>//andrius.mobi/2013/03/why-create-agi.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>The Asterisk dial plan is a powerful tool for creating custom voice applications using its built-in functions. The Asterisk Extension Language (AEL) offers a high-level syntax, similar to <code class="language-plaintext highlighter-rouge">extensions.conf</code>, for defining dial plan logic. With the dial plan, you can manipulate database data via <code class="language-plaintext highlighter-rouge">func_odbc</code>, execute Linux system scripts and process their results, send notifications to web applications using the <code class="language-plaintext highlighter-rouge">curl</code> function, and even send email or Jabber/Google Talk notifications.</p>

<p>Despite the capabilities of the dial plan, there are situations where using the Asterisk Gateway Interface (AGI) is more advantageous. Consider using AGI for the following reasons:</p>

<ol>
  <li><strong>Complex Dial Plan Logic:</strong> If your dial plan becomes overly complex with numerous macros and contexts, AGI can help simplify code management and improve readability.</li>
  <li><strong>Multi-Tenant Hosting:</strong> For systems hosting multiple customers, each with distinct needs and functionalities, AGI offers a more flexible and customizable solution.</li>
  <li><strong>Application Integration:</strong> When integration with external applications or web services is required, particularly for processing inbound and outbound events, AGI can facilitate seamless communication and data exchange.</li>
  <li><strong>API Development:</strong> AGI can be used to create an API, enabling third-party applications to interact with your Asterisk system.</li>
  <li><strong>Intensive Database Interaction:</strong> If your application relies heavily on a database and requires persistent or complex data access, AGI can provide the necessary capabilities more effectively than dial plan functions alone.</li>
</ol>

<p>It is important to adhere to the “KISS principle” (Keep It Simple, Stupid). If a task can be accomplished effectively using only the dial plan, that is generally the recommended approach. However, if the dial plan would require extensive calls to external shell scripts or involves significantly complex logic, developing an AGI application is often a more robust and maintainable solution.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/03/why-create-agi.html</guid>
                <description>
                    
                    In the world of Asterisk, the dial-plan is a powerful tool for creating custom voice applications. However, there are situations where using AGI (Asterisk Gateway Interface) is preferred. This article explores the reasons why AGI can be a valuable addition to your Asterisk system.
                    
                </description>
                <pubDate>Tue, 12 Mar 2013 21:07:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Click-to-call script for Windows users</title>
                <link>//andrius.mobi/2013/03/your-own-click-to-call-with-asterisk.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>This post shares an older project I developed for Asterisk: a click-to-call library featuring client and server components, which is compatible with Windows. Windows users can activate the <code class="language-plaintext highlighter-rouge">callto.rb</code> script, potentially integrating it with their CRM applications. Upon script execution, the user’s SIP phone would ring. The project is available at: https://github.com/andrius/asterisk-click-to-call-windows.</p>

<p>Key points:</p>

<ul>
  <li>The client application, <code class="language-plaintext highlighter-rouge">callto.rb</code>, can be compiled into a Windows executable (e.g., using <a href="http://www.erikveen.dds.nl/rubyscript2exe">rubyscript2exe</a>) or run from the command line if Ruby is installed on the Windows system.</li>
  <li>Credentials need to be configured in the <code class="language-plaintext highlighter-rouge">users.yml</code> file.</li>
  <li>The <code class="language-plaintext highlighter-rouge">server.rb</code> script must be running on the Asterisk server.</li>
</ul>

<p>The system is quite straightforward, though I apologize for the minimal commenting in the original code.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/03/your-own-click-to-call-with-asterisk.html</guid>
                <description>
                    
                    Sharing one of my older projects with Asterisk: a click-to-call library with client and server components. It does work with Windows!
                    
                </description>
                <pubDate>Sun, 10 Mar 2013 12:23:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>How to unlock Huawei modem</title>
                <link>//andrius.mobi/2013/03/how-to-unlock-huawei-modem.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>Following my previous post about creating a GSM gateway with a Raspberry Pi and a Huawei modem, I received several inquiries about the modem unlocking process.</p>

<p>The YouTube video below describes this process:</p>

<p>https://youtu.be/uL-drV_ZniM</p>
<style>
.videoWrapper {
	position: relative;
	padding-bottom: 56.333%;
	height: 0;
    background: black;
}
.videoWrapper iframe {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
    border: 0;
}    
</style>

<script>
function get_youtube_id(url) {
    var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
    return (url.match(p)) ? RegExp.$1 : false;
}
function vimeo_embed(url,el) {
    var id = false;
    $.ajax({
      url: 'https://vimeo.com/api/oembed.json?url='+url,
      async: true,
      success: function(response) {
        if(response.video_id) {
          id = response.video_id;
          if(url.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
          if(url.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
          var theInnerHTML = '<div class="videoWrapper"><iframe src="https://player.vimeo.com/video/'+id+'/?byline=0&title=0&portrait=0';
          if(autoplay==1) theInnerHTML += '&autoplay=1';
          if(loop==1) theInnerHTML += '&loop=1';
          theInnerHTML += '" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>'; 
          el.innerHTML = theInnerHTML;
        }
      }
    });
}
function video_embed() {
    var p = document.getElementsByTagName('p');
    for(var i = 0; i < p.length; i++) {
        //check if this is an external url (that starts with https:// or http://
        if (p[i].innerHTML.indexOf("http://") == 0 ||
            p[i].innerHTML.indexOf("https://") == 0) {
            var youtube_id = get_youtube_id(p[i].innerHTML);
            if(youtube_id) {
                if(p[i].innerHTML.indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                if(p[i].innerHTML.indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                var theInnerHTML = '<div class="videoWrapper"><iframe width="720" height="420" src="https://www.youtube.com/embed/' + youtube_id + '?rel=0&showinfo=0';
                if(autoplay==1) theInnerHTML += '&autoplay=1';
                if(loop==1) theInnerHTML += '&loop=1&playlist='+youtube_id+'&version=3';
                theInnerHTML += '" frameborder="0" allowfullscreen></iframe></div>';
                p[i].innerHTML = theInnerHTML;
            }
            if(p[i].innerHTML.indexOf('vimeo.com') !== -1) {
                //ask vimeo for the id and place the embed
                vimeo_embed(p[i].innerHTML,p[i]);
            }
        }
    }
}
video_embed();

function mp3_embed() {
    var p = document.getElementsByTagName('p');
    for(var i = 0; i < p.length; i++) {
        if(p[i].innerHTML.indexOf('.mp3') !== -1) {
            var str = p[i].innerHTML.split('?');
            if(str.length == 1) str[1] = '';
            var str1 = str[1];
            str1 = str1.replace('&','').replace('&','');
            str1 = str1.replace('autoplay=1','').replace('autoplay=0','');
            str1 = str1.replace('loop=1','').replace('loop=0','');
            str1 = str1.replace('controls=0','').replace('controls=1','');

            if (str[0].lastIndexOf('.mp3', str[0].length - 4) === str[0].length - 4 && str1.length == 0) {
                if(str[1].indexOf('autoplay=1') !== -1) var autoplay=1; else var autoplay=0;
                if(str[1].indexOf('loop=1') !== -1) var loop=1; else var loop=0;
                if(str[1].indexOf('controls=0') !== -1) var controls=0; else var controls=1;
                var newInnerHTML = '<audio';
                if(autoplay==1) newInnerHTML += ' autoplay';
                if(loop==1) newInnerHTML += ' loop';
                if(controls==1) newInnerHTML += ' controls';
                newInnerHTML += '><source src="'+str[0]+'" type="audio/mpeg">Your browser does not support the audio element.</audio>';
                p[i].innerHTML = newInnerHTML;
            }
        }
    }
}
mp3_embed();
</script>


                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/03/how-to-unlock-huawei-modem.html</guid>
                <description>
                    
                    After my last post about the GSM gateway based on Raspberry Pi and Huawei modem, I received a few questions asking how to unlock it. Below is a YouTube video that describes the process.
                    
                </description>
                <pubDate>Sat, 09 Mar 2013 21:12:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Asterisk on Raspberry Pi as GSM gateway</title>
                <link>//andrius.mobi/2013/03/asterisk-on-raspberry-pi-as-gsm-gateway.html</link>
                <content:encoded>
                    <![CDATA[
                    <h2 id="introduction">Introduction</h2>

<p>I recently installed <code class="language-plaintext highlighter-rouge">chan_dongle</code> on my <a href="http://www.raspberry-asterisk.org/">Asterisk PBX running on a Raspberry Pi</a>. The <a href="https://github.com/jstasiak/asterisk-chan-dongle"><code class="language-plaintext highlighter-rouge">chan_dongle</code></a> driver enables Asterisk PBX to use certain Huawei 3G USB dongles as a voice interface for handling voice calls, SMS, and USSD commands. This setup effectively creates a single-channel GSM gateway.</p>

<p><img src="/images/raspberry-pi-with-dongle.png" alt="Raspberry PI with Huawei 3G dongle" /></p>

<h2 id="prerequisites-and-setup">Prerequisites and Setup</h2>

<p>Follow these steps to prepare for <code class="language-plaintext highlighter-rouge">chan_dongle</code> installation:</p>

<ol>
  <li><strong>Obtain a compatible USB modem:</strong> Refer to the <a href="http://wiki.e1550.mobi/doku.php?id=requirements">list of compatible modems</a>.</li>
  <li><strong>Check modem status:</strong> Use the <a href="https://www.dc-unlocker.com/">DC-Unlocker software</a> to verify if the modem supports voice functions and is not locked.</li>
  <li><strong>Unlock modem (if necessary):</strong> Follow the <a href="http://wiki.e1550.mobi/doku.php?id=preparation">unlock instructions and resources</a>.</li>
  <li><strong>Firmware upgrade (optional):</strong> If DC-Unlocker indicates no voice function or if configuration issues arise, consider <a href="http://www.dc-files.com/files/huawei/">upgrading the modem’s firmware</a>.</li>
  <li>
    <p><strong>Prepare Raspberry Pi OS:</strong> Download <a href="http://www.raspberry-asterisk.org/downloads/">Raspberry Asterisk</a> and flash it onto an SD card (minimum 4GB). For macOS, the flashing process is as follows:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Identify your SD card (e.g., disk1)</span>
mount /dev/disk1
diskutil unmountDisk /dev/disk1
<span class="nb">sudo dd </span><span class="k">if</span><span class="o">=</span>raspbian_wheezy_20120608.img <span class="nv">of</span><span class="o">=</span>/dev/rdisk1 <span class="nv">bs</span><span class="o">=</span>1m
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="installation-steps">Installation Steps</h2>

<p>After preparing the SD card and booting the Raspberry Pi:</p>

<ol>
  <li>
    <p>Upgrade the system:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>raspbx-upgrade
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install necessary software packages:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get <span class="nb">install </span>usbutils unzip autoconf automake

<span class="c"># Compile USB-modeswitch</span>
<span class="nb">cd</span> /usr/src/

wget http://www.draisberghof.de/usb_modeswitch/usb-modeswitch-1.2.5.tar.bz2
wget http://www.draisberghof.de/usb_modeswitch/usb-modeswitch-data-20121109.tar.bz2

<span class="nb">tar</span> <span class="nt">-jxvf</span> usb-modeswitch-1.2.5.tar.bz2
<span class="nb">tar</span> <span class="nt">-jxvf</span> usb-modeswitch-data-20121109.tar.bz2

<span class="nb">cd </span>usb-modeswitch-1.2.5
make all
make <span class="nb">install

cd</span> ../usb-modeswitch-data-20121109
make <span class="nb">install

cd</span> ..
</code></pre></div>    </div>
  </li>
  <li>
    <p>Connect the Huawei USB stick (if already plugged, eject it first) and verify its detection using <code class="language-plaintext highlighter-rouge">lsusb</code>:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lsusb | <span class="nb">grep </span>Huawei
</code></pre></div>    </div>

    <p>The output should resemble:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Bus 001 Device 005: ID 12d1:140c Huawei Technologies Co., Ltd.
</code></pre></div>    </div>
  </li>
  <li>
    <p>Switch the USB stick to modem mode. Use the vendor (<code class="language-plaintext highlighter-rouge">v</code>) and product (<code class="language-plaintext highlighter-rouge">p</code>) IDs from the <code class="language-plaintext highlighter-rouge">lsusb</code> output. You may need to search online for your specific modem model to find the correct message content (<code class="language-plaintext highlighter-rouge">M</code> flag) for <code class="language-plaintext highlighter-rouge">usb_modeswitch</code>.</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>usb_modeswitch <span class="nt">-v</span> 0x12d1 <span class="nt">-p</span> 0x140c <span class="nt">-H</span> <span class="nt">-s</span> 5 <span class="nt">-M</span> 55534243000000000000000000000011060000000000000000000000000000
</code></pre></div>    </div>
  </li>
  <li>
    <p>Download and install chan_dongle:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code> wget https://github.com/jstasiak/asterisk-chan-dongle/archive/asterisk11.zip

 unzip asterisk11.zip

 <span class="nb">cd </span>asterisk-chan-dongle-asterisk11/
 aclocal
 autoconf
 automake <span class="nt">-a</span>
 ./configure
 make all
 make <span class="nb">install
 cp </span>etc/dongle.conf /etc/asterisk/
 <span class="c"># Consider backing up your existing extensions.conf before overwriting</span>
 <span class="c"># cp /etc/asterisk/extensions.conf /etc/asterisk/extensions.conf.backup</span>
 <span class="c"># cp etc/extensions.conf /etc/asterisk/extensions-dongle.conf</span>
 <span class="c"># It's generally better to include or merge parts of the example extensions.conf</span>
 <span class="c"># rather than replacing your main one. For this example, we'll assume you want to</span>
 <span class="c"># use the provided one, but in a real setup, careful merging is advised.</span>
 <span class="c"># For now, let's assume the user wants to copy it as extensions-dongle.conf</span>
 <span class="c"># and will include it manually or adjust their main extensions.conf.</span>
 <span class="nb">cp </span>etc/dongle.conf /etc/asterisk/ <span class="c"># This is correct</span>
 <span class="c"># The original instruction was: cp /etc/extensions.conf /etc/asterisk/extensions-dongle.conf</span>
 <span class="c"># This seems to imply copying the *system's* current extensions.conf to a new name,</span>
 <span class="c"># which is unusual. It's more likely the intention was to copy the *chan_dongle example*</span>
 <span class="c"># extensions.conf. Assuming the example is in `etc/extensions.conf` within the source.</span>
 <span class="c"># If there's an example extensions.conf in the chan_dongle source (e.g., in its 'etc' dir),</span>
 <span class="c"># it should be copied like this:</span>
 <span class="c"># cp etc/extensions.conf /etc/asterisk/extensions-dongle-example.conf</span>
 <span class="c"># For this correction, I will assume the original intent was to place the dongle-specific</span>
 <span class="c"># config into a separate file that the user can then integrate.</span>
 <span class="c"># The original line `cp /etc/extensions.conf /etc/asterisk/extensions-dongle.conf` is problematic.</span>
 <span class="c"># A safer approach is to copy the example config from the source if available.</span>
 <span class="c"># If `asterisk-chan-dongle-asterisk11/etc/extensions.conf` exists, it should be:</span>
 <span class="c"># cp etc/extensions.conf /etc/asterisk/extensions-dongle.sample.conf</span>
 <span class="c"># Given the ambiguity, I will comment out the problematic line and add a note.</span>
 <span class="c"># cp /etc/extensions.conf /etc/asterisk/extensions-dongle.conf # Review this step</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Restart Asterisk PBX and check the modem status:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asterisk <span class="nt">-rx</span> <span class="s2">"core restart now"</span>

<span class="c"># Check devices</span>
asterisk <span class="nt">-rx</span> <span class="s2">"dongle show devices"</span>
</code></pre></div>    </div>

    <p>You should see something like this:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># *CLI&gt; dongle show devices
# ID           Group State      RSSI Mode Submode Provider Name  Model      Firmware          IMEI             IMSI             Number
# dongle0      0     Free       2    0    0       Yoigo          E1762      11.126.13.00.00   xxxx yyy  Unknown
# *CLI&gt;
</code></pre></div>    </div>
  </li>
</ol>

<p>You have now successfully installed and configured <code class="language-plaintext highlighter-rouge">chan_dongle</code>. The next step is to configure your new GSM gateway within Asterisk.</p>

<p>I am still experimenting with this setup, but so far, the voice quality has been good—better than my experience with a Portech GSM gateway. The cost per port is also more favorable, and this solution supports sending and receiving SMS and USSD messages.</p>

<p>Good luck!</p>

<p>If you wish to try my pre-configured system, you can download the latest image <a href="https://j.mp/tinypbx">here</a>. Flashing instructions are standard for Raspberry Pi images: decompress the .gz file, insert the SD card, and use the <code class="language-plaintext highlighter-rouge">dd</code> command on Linux. For detailed flashing procedures, refer to resources like <a href="https://www.andrewmunsell.com/blog/getting-started-raspberry-pi-install-raspbian">this guide on installing Raspbian</a>.</p>

<h2 id="useful-links">Useful Links</h2>

<ul>
  <li><a href="http://wiki.e1550.mobi/doku.php?id=usage">Asterisk CLI commands for <code class="language-plaintext highlighter-rouge">chan_dongle</code> and additional instructions</a></li>
  <li><a href="http://gix.net.pl/raspberry-pi/">Resource on <code class="language-plaintext highlighter-rouge">chan_dongle</code> with Raspberry Pi</a></li>
  <li><a href="http://habrahabr.ru/post/160299/">Helpful <code class="language-plaintext highlighter-rouge">chan_dongle</code> resource (in Russian; use Google Translate)</a></li>
  <li><a href="http://wiki.e1550.mobi/doku.php?id=troubleshooting">Troubleshooting Huawei modems</a></li>
</ul>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/03/asterisk-on-raspberry-pi-as-gsm-gateway.html</guid>
                <description>
                    
                    Yesterday, I installed chan_dongle for my Asterisk PBX running on Raspberry Pi. chan_dongle is a driver that enables the use of Huawei 3G USB dongles as a voice &quot;board&quot; for handling voice, SMS, and USSD. I conducted extensive research on various topics and summarized everything in a document. Additionally, I provided useful links related to Asterisk CLI commands, troubleshooting Huawei modems, and additional resources for chan_dongle.
                    
                </description>
                <pubDate>Tue, 05 Mar 2013 19:50:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Time based conditions in voice application</title>
                <link>//andrius.mobi/2013/02/time-based-conditions-in-agi-application.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>Typical telephony systems process incoming call flows based on various time conditions, and customers often require control over these time ranges. The platform might also be a multi-tenant server hosting different virtual PBXes.</p>

<p>Common time-based call-handling scenarios include:</p>

<ul>
  <li><strong>Night:</strong> Calls are routed to voicemail.</li>
  <li><strong>Morning, Lunchtime, Evening:</strong> Calls are forwarded to a mobile phone.</li>
  <li><strong>Business Hours:</strong> Calls follow standard call-flow logic.</li>
  <li><strong>Fridays:</strong> Working hours are shorter.</li>
  <li><strong>Saturdays:</strong> The company operates only until lunchtime.</li>
  <li><strong>Sundays:</strong> The company is closed; calls go to voicemail.</li>
  <li><strong>Public Holidays:</strong> Calls are forwarded to voicemail.</li>
</ul>

<p>Some time ago, I developed the following Ruby classes and ActiveRecord migrations for flexible business time management. I am sharing them now, as they could be beneficial for anyone implementing time-based conditions in backend applications, not limited to telephony.</p>

<p>The <code class="language-plaintext highlighter-rouge">Item</code> class utilizes a polymorphic association that can point to any voice-related entity within a PBX (e.g., extension, voicemail, conference). This approach allows for the creation of highly flexible call flow building blocks. These blocks can be linked to various PBX entities, enabling customizable and dynamic call handling based on specific time conditions.</p>

<p>When the <code class="language-plaintext highlighter-rouge">operational?</code> method is triggered for a given business-time collection, it returns the <code class="language-plaintext highlighter-rouge">item_id</code> if the time conditions are met, or <code class="language-plaintext highlighter-rouge">nil</code> otherwise (indicating, for example, that the office is closed).</p>

<h3 id="tests">Tests</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.9.3-p327 :001 &gt; Campaign.last.business_time.operational?

Campaign Load (0.1ms)  SELECT "campaigns".* FROM "campaigns" ORDER BY "campaigns"."id" DESC LIMIT 1
BusinessTime Load (0.2ms)  SELECT "business_times".* FROM "business_times" WHERE "business_times"."id" = 1 LIMIT 1
BusinessTimeMember Load (0.3ms)  SELECT "business_time_members".* FROM "business_time_members" WHERE "business_time_members"."business_time_id" = 1 ORDER BY
  business_time_id,
  day_of_month desc,
  month desc,
  year desc,
  weekday desc,
  time_from desc,
  time_to asc

=&gt; 0
</code></pre></div></div>
<h3 id="migrations">Migrations</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="ss">:business_time_members</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">string</span>   <span class="ss">:name</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">100</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">integer</span>  <span class="ss">:business_time_id</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">time</span>     <span class="ss">:time_from</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">'2000-01-01 00:00:00'</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">time</span>     <span class="ss">:time_to</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">'2000-01-01 23:59:59'</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">integer</span>  <span class="ss">:weekday</span>      <span class="c1"># 0 - sunday, 1 - monday, 2 -tuesday, ...</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">integer</span>  <span class="ss">:day_of_month</span> <span class="c1"># 1-31</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">integer</span>  <span class="ss">:month</span>        <span class="c1"># 1-12</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">integer</span>  <span class="ss">:year</span>         <span class="c1"># 2012</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">integer</span>  <span class="ss">:item_id</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>      <span class="c1"># item with action!</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
<span class="k">end</span>

<span class="n">create_table</span> <span class="ss">:business_times</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:name</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">100</span>
	<span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
<span class="k">end</span>

<span class="n">execute</span> <span class="s2">"INSERT INTO `business_times` (`id`, `name`)
	VALUES (1, 'Call Mon-Fri 9 to 21; Sat, Sun 11 to 19')"</span>

<span class="c1"># Always closed!</span>
<span class="c1"># It is a default condition with lowest priority and will be executed it other conditions did not met.</span>
<span class="c1"># BusinessTimeMember.create :business_time =&gt; business_time, :item =&gt; closed_action</span>
<span class="n">execute</span> <span class="s2">"INSERT INTO `business_time_members` (`id`, `business_time_id`, `item_id`) VALUES (?, 1, NULL)"</span>
<span class="c1"># Make calls on business days (Monday to Friday) from 9:00 to 21:00,</span>
<span class="c1"># on weekends (Sunday and Saturday) from 11:00 to 19:00</span>
<span class="c1"># 0 - Sun, 6 - Sat</span>
<span class="mi">0</span><span class="p">.</span><span class="nf">upto</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">day</span><span class="o">|</span>
	<span class="n">time_from</span><span class="p">,</span> <span class="n">time_to</span> <span class="o">=</span> <span class="k">if</span> <span class="n">day</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">day</span> <span class="o">==</span> <span class="mi">6</span> <span class="k">then</span>
		<span class="c1">#[Time.parse("11:00:00"), Time.parse("18:59:59")]</span>
		<span class="p">[</span><span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"00:00:00"</span><span class="p">),</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"23:59:59"</span><span class="p">)]</span>
	<span class="k">else</span>
		<span class="c1">#[Time.parse("9:00:00"), Time.parse("20:59:59")]</span>
		<span class="p">[</span><span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"00:00:00"</span><span class="p">),</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"23:59:59"</span><span class="p">)]</span>
	<span class="k">end</span>

	<span class="c1"># item_id 0 = continue dialplan!</span>
	<span class="c1"># BusinessTimeMember.create :business_time =&gt; business_time,</span>
	<span class="c1">#   :item_id =&gt; 0, :weekday =&gt; day,</span>
	<span class="c1">#   :time_from =&gt; "6:00", :time_to =&gt; "17:00"</span>
	<span class="n">execute</span> <span class="s2">"INSERT INTO `business_time_members`
		(`id`, `business_time_id`, `weekday`, `time_from`, `time_to`, `item_id`)
		VALUES (?, 1, </span><span class="si">#{</span><span class="n">day</span><span class="si">}</span><span class="s2">, '</span><span class="si">#{</span><span class="n">time_from</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">time_to</span><span class="si">}</span><span class="s2">', 0)"</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="models">Models</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BusinessTimeMember</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1">#validations</span>
  <span class="n">validates_presence_of</span> <span class="ss">:business_time_id</span>
  <span class="n">validates_presence_of</span> <span class="ss">:item_id</span>
  <span class="c1"># 0 (zero) means to continue dialplan after check!</span>
  <span class="n">validates_numericality_of</span> <span class="ss">:item_id</span> <span class="c1">#, :greater_than =&gt; 0</span>

  <span class="c1"># relations</span>
  <span class="n">belongs_to</span> <span class="ss">:business_time</span>
  <span class="n">belongs_to</span> <span class="ss">:item</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">BusinessTime</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:business_time_members</span><span class="p">,</span> <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:items</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="ss">:routable</span>

  <span class="n">has_many</span> <span class="ss">:soho_pbxes</span>

  <span class="c1"># return false if no records found,</span>
  <span class="c1"># 0 if specified - means "continue" dialplan,</span>
  <span class="c1"># or item_id</span>
  <span class="k">def</span> <span class="nf">operational?</span><span class="p">(</span><span class="n">details</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:datetime</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">utc</span> <span class="p">})</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="ss">:datetime</span><span class="p">]</span>

    <span class="k">begin</span>
      <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="nf">timezone</span>
        <span class="k">begin</span>
          <span class="n">tz</span> <span class="o">=</span> <span class="no">TZInfo</span><span class="o">::</span><span class="no">Timezone</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nf">timezone</span><span class="p">)</span>
          <span class="n">local</span> <span class="o">=</span> <span class="n">tz</span><span class="p">.</span><span class="nf">utc_to_local</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
          <span class="nb">puts</span> <span class="s2">"got timezone </span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">timezone</span><span class="si">}</span><span class="s2"> - utc </span><span class="si">#{</span><span class="n">d</span><span class="si">}</span><span class="s2">, local </span><span class="si">#{</span><span class="n">local</span><span class="si">}</span><span class="s2">"</span>
          <span class="n">d</span> <span class="o">=</span> <span class="n">local</span>
        <span class="k">rescue</span>
          <span class="nb">puts</span> <span class="s2">"got exception for timezone </span><span class="si">#{</span><span class="nb">self</span><span class="p">.</span><span class="nf">timezone</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">tm</span> <span class="o">=</span> <span class="no">BusinessTimeMember</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span>
      <span class="ss">:all</span><span class="p">,</span>
      <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:business_time_id</span> <span class="o">=&gt;</span> <span class="nb">id</span> <span class="p">},</span>
      <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s2">"
        business_time_id,
        day_of_month desc,
        month desc,
        year desc,
        weekday desc,
        time_from desc,
        time_to asc
      "</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">tm</span><span class="p">.</span><span class="nf">empty?</span>
    <span class="n">tm</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">tf</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="ss">:time_from</span><span class="p">]</span> <span class="p">?</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="ss">:time_from</span><span class="p">].</span><span class="nf">strftime</span><span class="p">(</span><span class="s2">"%H:%M:%S"</span><span class="p">))</span> <span class="p">:</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"00:00:00"</span><span class="p">)</span>
      <span class="n">tt</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="ss">:time_to</span><span class="p">]</span> <span class="p">?</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="ss">:time_to</span><span class="p">].</span><span class="nf">strftime</span><span class="p">(</span><span class="s2">"%H:%M:%S"</span><span class="p">))</span> <span class="p">:</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"23:59:59"</span><span class="p">)</span>
      <span class="n">tw</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="ss">:weekday</span><span class="p">]</span> <span class="p">?</span> <span class="n">t</span><span class="p">[</span><span class="ss">:weekday</span><span class="p">].</span><span class="nf">to_i</span> <span class="p">:</span> <span class="n">d</span><span class="p">.</span><span class="nf">wday</span>
      <span class="n">td</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="ss">:day_of_month</span><span class="p">]</span> <span class="p">?</span> <span class="n">t</span><span class="p">[</span><span class="ss">:day_of_month</span><span class="p">].</span><span class="nf">to_i</span> <span class="p">:</span> <span class="n">d</span><span class="p">.</span><span class="nf">day</span>
      <span class="n">tm</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="ss">:month</span><span class="p">]</span> <span class="p">?</span> <span class="n">t</span><span class="p">[</span><span class="ss">:month</span><span class="p">].</span><span class="nf">to_i</span> <span class="p">:</span> <span class="n">d</span><span class="p">.</span><span class="nf">month</span>
      <span class="n">ty</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="ss">:year</span><span class="p">]</span> <span class="p">?</span> <span class="n">t</span><span class="p">[</span><span class="ss">:year</span><span class="p">].</span><span class="nf">to_i</span> <span class="p">:</span> <span class="n">d</span><span class="p">.</span><span class="nf">year</span>

      <span class="k">if</span> <span class="n">ty</span> <span class="o">==</span> <span class="n">d</span><span class="p">.</span><span class="nf">year</span> <span class="o">&amp;&amp;</span> <span class="n">tm</span> <span class="o">==</span> <span class="n">d</span><span class="p">.</span><span class="nf">month</span> <span class="o">&amp;&amp;</span> <span class="n">td</span> <span class="o">==</span> <span class="n">d</span><span class="p">.</span><span class="nf">day</span> <span class="o">&amp;&amp;</span> <span class="n">tw</span> <span class="o">==</span> <span class="n">d</span><span class="p">.</span><span class="nf">wday</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">&gt;=</span> <span class="n">tf</span> <span class="o">&amp;&amp;</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">tt</span> <span class="k">then</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="nf">item_id</span>
      <span class="k">end</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/02/time-based-conditions-in-agi-application.html</guid>
                <description>
                    
                    The typical telephony system processes incoming call flows based on different times. Customers want to have control over this and handle time ranges. The platform can also be a multi-tenant server with different virtual PBXes. In my implementation, I use Ruby, ActiveRecord, and polymorphic associations to create routing blocks. By reusing polymorphic database associations, I can create flexible call flow building blocks. These blocks can be linked to any voice-related entity in a PBX, such as an extension, voicemail, conference, etc. This enables customizable and dynamic call handling based on time conditions.
                    
                </description>
                <pubDate>Fri, 22 Feb 2013 22:54:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Delete voice recordings older than N-days</title>
                <link>//andrius.mobi/2013/02/delete-voice-recordings-older-than-n-days.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>In telephony systems with high call volumes, enabling instant call recording or experiencing heavy voicemail usage can lead to rapid disk space consumption. Regularly purging old recordings is advisable.</p>

<p>Create an executable bash file and place it in the <code class="language-plaintext highlighter-rouge">cron.daily</code> directory:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>
<span class="nb">cd</span> /var/spool/asterisk/monitor

<span class="c"># Find and delete files older than 31 days.</span>
<span class="c"># Modify 'rm -f' for other operations, e.g., backup before deletion.</span>
find <span class="nb">.</span> <span class="nt">-mtime</span> +31 <span class="nt">-exec</span> <span class="nb">rm</span> <span class="nt">-f</span> <span class="o">{}</span> <span class="se">\;</span>
</code></pre></div></div>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/02/delete-voice-recordings-older-than-n-days.html</guid>
                <description>
                    
                    Disk space running out fast in loaded telephony systems with instant call recording  or either with heavy usage of voicemail. It&apos;s good to purge them on regular basis.
                    
                </description>
                <pubDate>Fri, 22 Feb 2013 09:30:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Questionnaire application with Asterisk PBX AGI + Ruby</title>
                <link>//andrius.mobi/2013/02/questionnaire-with-asterisk-pbx-agi-ruby.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>Several AGI implementations are available for Ruby, with <a href="https://github.com/adhearsion/adhearsion">Adhearsion</a> currently being a prominent one. I frequently use Adhearsion for my projects. While it is a powerful tool, its size can sometimes limit flexibility.</p>

<p>Prior to Adhearsion, I utilized <a href="https://github.com/andrius/AsteriskRuby">AsteriskRuby</a>. This library provides AGI and FastAGI connectivity with Asterisk. When combined with <a href="https://github.com/andrius/rastman">Rastman</a>, it also allows access to the Asterisk Manager Interface (AMI). This combination offers versatile functionality. I appreciate both implementations for their simplicity, which facilitates executing Asterisk commands, receiving AMI events, and troubleshooting, even for those not deeply familiar with Ruby. They offer excellent performance, are free of memory leaks, and provide simple, flexible libraries.</p>

<p>Returning to the main topic: the Questionnaire application. This application, based on the AsteriskRuby gem, has been in production for some time. It was initially developed for a small project, and I have now decided to share it with the VoIP community.</p>

<p>The code was developed for Asterisk 1.6.x/1.8.x and Ruby 1.8.x.</p>

<p>To set it up:</p>

<ol>
  <li>Deploy the code on a local server running Asterisk.</li>
  <li>Create a file named <code class="language-plaintext highlighter-rouge">codes.txt</code> containing phone numbers and PIN codes.</li>
  <li>Prepare the necessary voice recordings (filenames and messages can be found in the application’s source code).</li>
  <li>Update the <code class="language-plaintext highlighter-rouge">extensions.conf</code> file, directing the relevant extension to the FastAGI.</li>
</ol>

<p>Application workflow:</p>

<ul>
  <li><strong>New callers:</strong> The system plays a welcome announcement.</li>
  <li><strong>Returning callers:</strong> A “welcome back” announcement is played (authentication is based on caller ID and PIN).</li>
  <li>The application prompts the caller to enter a PIN code.</li>
  <li>Upon successful authentication, the system resumes from the last unanswered question (or starts with the first question for new callers).</li>
  <li>There is no limit on the number of attempts. Answers and call records are stored in the database.</li>
</ul>

<p>Below is the source code for the FastAGI implementation in Ruby:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/bin/env ruby</span>

<span class="nb">require</span> <span class="s1">'rubygems'</span>
<span class="nb">require</span> <span class="s1">'mysql'</span>
<span class="nb">require</span> <span class="s1">'active_record'</span>
<span class="nb">require</span> <span class="s1">'AGIServer'</span>
<span class="nb">require</span> <span class="s1">'AGIMenu'</span>
<span class="nb">require</span> <span class="s1">'AGISelection'</span>
<span class="nb">require</span> <span class="s1">'daemons'</span>

<span class="no">APP_ROOT</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">))</span>

<span class="c1"># Questionnaire / voting is statis and here we have a list of correct answers</span>
<span class="no">CORRECT_ANSWERS</span> <span class="o">=</span> <span class="sx">%w(2 3 2 1 3 1 1 1 1 3)</span>

<span class="c1"># database credentials</span>
<span class="no">DATABASE</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:adapter</span> <span class="o">=&gt;</span> <span class="ss">:mysql</span><span class="p">,</span>
  <span class="ss">:encoding</span> <span class="o">=&gt;</span> <span class="ss">:utf8</span><span class="p">,</span>
  <span class="ss">:database</span> <span class="o">=&gt;</span> <span class="s1">'voip'</span><span class="p">,</span>
  <span class="ss">:pool</span> <span class="o">=&gt;</span> <span class="mi">250</span><span class="p">,</span>
  <span class="ss">:connections</span> <span class="o">=&gt;</span> <span class="mi">12</span><span class="p">,</span>
  <span class="ss">:username</span> <span class="o">=&gt;</span> <span class="s1">'voip'</span><span class="p">,</span>
  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s1">'PASSWORD'</span><span class="p">,</span>
  <span class="c1">#:socket =&gt; '/var/run/mysqld/mysqld.pid',</span>
  <span class="ss">:host</span> <span class="o">=&gt;</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span>
  <span class="ss">:reconnect</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="p">}</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">establish_connection</span> <span class="no">DATABASE</span>

<span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDERR</span><span class="p">)</span>
<span class="n">logger</span><span class="p">.</span><span class="nf">level</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">::</span><span class="no">DEBUG</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="n">logger</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">colorize_logging</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># create AR classes and DB tables</span>
<span class="k">class</span> <span class="nc">VoteQuestion</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">set_primary_key</span> <span class="ss">:question_number</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Questionnaire</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">;</span> <span class="k">end</span>

<span class="c1"># create DB tables if not exists (dirty way!)</span>
<span class="k">if</span> <span class="o">!</span> <span class="no">VoteQuestion</span><span class="p">.</span><span class="nf">table_exists?</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
    <span class="n">create_table</span> <span class="ss">:questionnairies</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:pin_code</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1">#(1..10).each do |pin_code|</span>
  <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">APP_ROOT</span><span class="si">}</span><span class="s2">/codes.txt"</span><span class="p">).</span><span class="nf">chomp</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pin_code</span><span class="o">|</span>
    <span class="no">Questionnaire</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span> <span class="ss">:pin_code</span> <span class="o">=&gt;</span> <span class="s2">"00000000</span><span class="si">#{</span><span class="n">pin_code</span><span class="p">.</span><span class="nf">chomp</span><span class="si">}</span><span class="s2">"</span><span class="p">[</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span> <span class="p">)</span>
  <span class="k">end</span>

  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
    <span class="n">create_table</span> <span class="ss">:phone_numbers</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:questionnaire_id</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="kp">nil</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:number</span><span class="p">,</span> <span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="ss">:unsigned</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:question_number</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:count_of_calls_made</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:amount_of_asked_questions</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:amount_of_correct_answers</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:total_amount_of_asked_questions</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:total_amount_of_correct_answers</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">boolean</span> <span class="ss">:sms_sent</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="kp">false</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:phone_numbers</span><span class="p">,</span> <span class="ss">:number</span>
  <span class="k">end</span>

  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="p">.</span><span class="nf">define</span> <span class="k">do</span>
    <span class="n">create_table</span> <span class="ss">:vote_questions</span><span class="p">,</span> <span class="ss">:primary_key</span> <span class="o">=&gt;</span> <span class="ss">:question_number</span> <span class="k">do</span> <span class="o">|</span><span class="n">table</span><span class="o">|</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:amount_of_answers</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">3</span>
      <span class="n">table</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:correct_answer</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">question_no</span><span class="o">|</span>
    <span class="no">VoteQuestion</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="ss">:question_number</span> <span class="o">=&gt;</span> <span class="n">question_no</span><span class="p">,</span>
      <span class="ss">:amount_of_answers</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
      <span class="ss">:correct_answer</span> <span class="o">=&gt;</span> <span class="no">CORRECT_ANSWERS</span><span class="p">[</span><span class="n">question_no</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">to_i</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">PhoneNumber</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">validates_uniqueness_of</span> <span class="ss">:number</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">CallAttempt</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:phone_number</span>
<span class="k">end</span>

<span class="c1"># AGI classes</span>
<span class="k">class</span> <span class="nc">Farmacy</span> <span class="o">&lt;</span> <span class="no">AGIRoute</span>

  <span class="c1"># this method will be called from asteris dialplan (AGI calling) for every new inbound phone call</span>
  <span class="k">def</span> <span class="nf">vote</span>
    <span class="k">begin</span>
      <span class="n">agi</span><span class="p">.</span><span class="nf">answer</span>

      <span class="no">AGIMenu</span><span class="p">.</span><span class="nf">sounds_dir</span> <span class="o">=</span> <span class="no">AGISelection</span><span class="p">.</span><span class="nf">sounds_dir</span> <span class="o">=</span> <span class="no">APP_ROOT</span> <span class="o">+</span> <span class="s1">'/'</span>

      <span class="c1"># prepare the IVR menu</span>
      <span class="nb">hash</span> <span class="o">=</span> <span class="p">{</span><span class="ss">:introduction</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"welcome"</span><span class="p">,</span> <span class="s2">"instructions"</span><span class="p">],</span>
        <span class="ss">:conclusion</span><span class="o">=&gt;</span><span class="s2">"what-is-your-choice"</span><span class="p">,</span>
        <span class="ss">:timeout</span><span class="o">=&gt;</span><span class="mi">17</span><span class="p">,</span>
        <span class="ss">:choices</span><span class="o">=&gt;</span>
        <span class="p">[{</span><span class="ss">:dtmf</span><span class="o">=&gt;</span><span class="s2">"*"</span><span class="p">,</span> <span class="ss">:audio</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"to-go-back"</span><span class="p">,</span> <span class="s2">"press"</span><span class="p">,</span> <span class="s2">"digits/star"</span><span class="p">]},</span>
          <span class="p">{</span><span class="ss">:dtmf</span><span class="o">=&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="ss">:audio</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"press"</span><span class="p">,</span> <span class="s2">"digits/1"</span><span class="p">,</span> <span class="s2">"for-option-1"</span><span class="p">]},</span>
          <span class="p">{</span><span class="ss">:dtmf</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:audio</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"press"</span><span class="p">,</span> <span class="s2">"digits/2"</span><span class="p">,</span> <span class="s2">"for-option-2"</span><span class="p">]},</span>
          <span class="p">{</span><span class="ss">:dtmf</span><span class="o">=&gt;</span><span class="s2">"#"</span><span class="p">,</span> <span class="ss">:audio</span><span class="o">=&gt;</span><span class="p">[</span><span class="s2">"or"</span><span class="p">,</span> <span class="s2">"press"</span><span class="p">,</span> <span class="s2">"digits/pound"</span><span class="p">,</span> <span class="s2">"to-repeat"</span><span class="p">]}]}</span>

      <span class="c1"># fix callerid and locate caller</span>
      <span class="n">e164</span> <span class="o">=</span> <span class="n">agi</span><span class="p">.</span><span class="nf">channel_params</span><span class="p">[</span><span class="s1">'callerid'</span><span class="p">].</span><span class="nf">to_i</span>
      <span class="n">number</span> <span class="o">=</span> <span class="no">PhoneNumber</span><span class="p">.</span><span class="nf">find_by_number</span><span class="p">(</span><span class="n">e164</span><span class="p">)</span>

      <span class="c1"># increase calls counter for existiing in DB phone number</span>
      <span class="k">unless</span> <span class="n">number</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="n">number</span><span class="p">.</span><span class="nf">count_of_calls_made</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">number</span><span class="p">.</span><span class="nf">save</span>
      <span class="k">end</span>
      <span class="c1"># create a new DB record for non-existing in DB phone number</span>
      <span class="n">phone_number</span> <span class="o">=</span> <span class="k">if</span> <span class="n">number</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="n">pn</span> <span class="o">=</span> <span class="no">PhoneNumber</span><span class="p">.</span><span class="nf">create</span> <span class="ss">:number</span> <span class="o">=&gt;</span> <span class="n">e164</span><span class="p">,</span> <span class="ss">:count_of_calls_made</span> <span class="o">=&gt;</span> <span class="mi">1</span>

        <span class="c1"># say 'welcome' or 'welcome back' &amp; save state of caller</span>
        <span class="n">pn</span><span class="p">.</span><span class="nf">questionnaire_id</span> <span class="o">=</span> <span class="n">hello_new_caller</span><span class="p">()</span>
        <span class="n">pn</span><span class="p">.</span><span class="nf">save</span>
        <span class="n">pn</span>

      <span class="c1"># if caller is not assigned to the specific Questionnaire, ...</span>
      <span class="k">elsif</span> <span class="n">number</span><span class="p">.</span><span class="nf">questionnaire_id</span><span class="p">.</span><span class="nf">nil?</span>
        <span class="c1"># say 'welcome' or 'welcome back' &amp; save state of caller</span>
        <span class="n">number</span><span class="p">.</span><span class="nf">questionnaire_id</span> <span class="o">=</span> <span class="n">hello_new_caller</span><span class="p">()</span>
        <span class="n">number</span><span class="p">.</span><span class="nf">save</span>
        <span class="n">number</span>


      <span class="k">else</span>
        <span class="n">welcome_back</span> <span class="n">number</span><span class="p">.</span><span class="nf">question_number</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">?</span> <span class="s1">'Hello_repeat_nopin'</span> <span class="p">:</span> <span class="s1">'Hello_repeat'</span>
        <span class="n">number</span>
      <span class="k">end</span>

      <span class="n">agi</span><span class="p">.</span><span class="nf">exec</span> <span class="s1">'Playback silence/1'</span>
      <span class="n">ask_question</span> <span class="ss">:phone_number</span> <span class="o">=&gt;</span> <span class="n">phone_number</span>
      <span class="n">thanks!</span> <span class="ss">:phone_number</span> <span class="o">=&gt;</span> <span class="n">phone_number</span>

    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">err</span>
      <span class="nb">puts</span> <span class="s2">"&gt;&gt;&gt;&gt;&gt;&gt; ERROR: "</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="nf">backtrace</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">play_ivr</span><span class="p">(</span><span class="n">ivr</span><span class="p">)</span>
    <span class="k">begin</span>
      <span class="n">menu</span> <span class="o">=</span> <span class="no">AGIMenu</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">ivr</span><span class="p">)</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">menu</span><span class="p">.</span><span class="nf">play</span><span class="p">(</span><span class="ss">:agi</span> <span class="o">=&gt;</span> <span class="n">agi</span><span class="p">)</span>
      <span class="n">result</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">err</span>
      <span class="nb">puts</span> <span class="s2">"&gt;&gt;&gt;&gt;&gt;&gt; ERROR: "</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="nf">backtrace</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">playback</span><span class="p">(</span><span class="n">audio</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">play_ivr</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="n">timeout</span><span class="p">,</span> <span class="ss">:introduction</span> <span class="o">=&gt;</span> <span class="n">audio</span><span class="p">,</span>
      <span class="ss">:choices</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">},</span>
        <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">},</span> <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">},</span>
        <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">7</span><span class="p">},</span> <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">8</span><span class="p">},</span> <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">9</span><span class="p">},</span>
        <span class="p">{</span><span class="ss">:dtmf</span><span class="o">=&gt;</span><span class="s1">'*'</span><span class="p">},</span> <span class="p">{</span><span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="ss">:dtmf</span><span class="o">=&gt;</span><span class="s1">'#'</span><span class="p">}</span> <span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">press_one_to_confirm</span><span class="p">(</span><span class="n">return_value</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="nf">upto</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">count</span><span class="o">|</span>
      <span class="n">selection</span> <span class="o">=</span>  <span class="n">playback</span><span class="p">(</span><span class="s1">'Wright'</span><span class="p">,</span> <span class="mi">3</span><span class="p">).</span><span class="nf">to_s</span>
      <span class="k">break</span> <span class="n">return_value</span> <span class="k">if</span> <span class="n">selection</span><span class="p">.</span><span class="nf">to_s</span> <span class="o">==</span> <span class="s1">'1'</span>
      <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">then</span>
        <span class="n">agi</span><span class="p">.</span><span class="nf">exec</span> <span class="s2">"Busy 12"</span>
        <span class="n">agi</span><span class="p">.</span><span class="nf">exec</span> <span class="s2">"Hangup"</span>
        <span class="k">break</span> <span class="kp">nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">hello_new_caller</span>
    <span class="k">begin</span>
      <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="nf">upto</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">count</span><span class="o">|</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span>
          <span class="no">AGISelection</span><span class="p">.</span><span class="nf">new</span> <span class="ss">:audio</span> <span class="o">=&gt;</span> <span class="s1">'Hello'</span><span class="p">,</span> <span class="ss">:max_digits</span> <span class="o">=&gt;</span> <span class="mi">8</span>
        <span class="k">else</span>
          <span class="no">AGISelection</span><span class="p">.</span><span class="nf">new</span> <span class="ss">:audio</span> <span class="o">=&gt;</span> <span class="s1">'Wrong'</span><span class="p">,</span> <span class="ss">:max_digits</span> <span class="o">=&gt;</span> <span class="mi">8</span>
        <span class="k">end</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">selection</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="ss">:agi</span> <span class="o">=&gt;</span> <span class="n">agi</span><span class="p">)</span>
        <span class="n">questionnaire</span> <span class="o">=</span> <span class="no">Questionnaire</span><span class="p">.</span><span class="nf">find_by_pin_code</span><span class="p">(</span><span class="n">code</span><span class="p">.</span><span class="nf">to_s</span><span class="p">)</span>
        <span class="k">break</span> <span class="n">questionnaire</span> <span class="k">unless</span> <span class="n">questionnaire</span><span class="p">.</span><span class="nf">nil?</span>
      <span class="k">end</span>
      <span class="k">if</span> <span class="n">result</span><span class="p">.</span><span class="nf">class</span> <span class="o">==</span> <span class="no">Questionnaire</span>
        <span class="n">press_one_to_confirm</span> <span class="n">result</span><span class="p">.</span><span class="nf">id</span>
      <span class="k">else</span>
        <span class="n">agi</span><span class="p">.</span><span class="nf">exec</span> <span class="s2">"Busy 12"</span>
        <span class="n">agi</span><span class="p">.</span><span class="nf">exec</span> <span class="s2">"Hangup"</span>
        <span class="kp">nil</span>
      <span class="k">end</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">err</span>
      <span class="nb">puts</span> <span class="s2">"&gt;&gt;&gt;&gt;&gt;&gt; ERROR: "</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="nf">backtrace</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">welcome_back</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s1">'Hello_repeat'</span><span class="p">)</span>
    <span class="n">playback</span> <span class="n">message</span>
    <span class="n">press_one_to_confirm</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">ask_question</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">{})</span>
    <span class="k">begin</span>
      <span class="n">phone_number</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:phone_number</span><span class="p">]</span>
      <span class="n">question_number</span> <span class="o">=</span> <span class="n">phone_number</span><span class="p">.</span><span class="nf">question_number</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">question_data</span> <span class="o">=</span>  <span class="no">VoteQuestion</span><span class="p">.</span><span class="nf">find_by_question_number</span><span class="p">(</span><span class="n">question_number</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">question_data</span><span class="p">.</span><span class="nf">nil?</span> <span class="k">then</span> <span class="c1"># finalize work - no more questions</span>
        <span class="k">return</span>
      <span class="k">end</span>
      <span class="n">ivr_data</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:introduction</span> <span class="o">=&gt;</span> <span class="n">question_number</span><span class="p">,</span> <span class="ss">:choices</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="p">],</span> <span class="ss">:timeout</span> <span class="o">=&gt;</span> <span class="mi">12</span> <span class="p">}</span>
      <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="p">(</span><span class="n">question_data</span><span class="p">.</span><span class="nf">amount_of_answers</span><span class="p">)).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">possible_answer</span><span class="o">|</span>
        <span class="n">ivr_data</span><span class="p">[</span><span class="ss">:choices</span><span class="p">].</span><span class="nf">push</span><span class="p">({</span>
          <span class="ss">:dtmf</span> <span class="o">=&gt;</span> <span class="n">possible_answer</span><span class="p">,</span>
          <span class="ss">:audio</span> <span class="o">=&gt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">question_number</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">possible_answer</span><span class="si">}</span><span class="s2">"</span>
        <span class="p">})</span>
      <span class="k">end</span>
      <span class="n">ivr_result</span> <span class="o">=</span> <span class="n">play_ivr</span> <span class="n">ivr_data</span>
      <span class="n">phone_number</span><span class="p">.</span><span class="nf">question_number</span> <span class="o">=</span> <span class="n">question_number</span>
      <span class="n">phone_number</span><span class="p">.</span><span class="nf">amount_of_asked_questions</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">phone_number</span><span class="p">.</span><span class="nf">total_amount_of_asked_questions</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">question_data</span><span class="p">.</span><span class="nf">correct_answer</span> <span class="o">==</span> <span class="n">ivr_result</span><span class="p">.</span><span class="nf">to_i</span>
        <span class="n">phone_number</span><span class="p">.</span><span class="nf">amount_of_correct_answers</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">phone_number</span><span class="p">.</span><span class="nf">total_amount_of_correct_answers</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">end</span>

      <span class="n">phone_number</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">ask_question</span> <span class="ss">:phone_number</span> <span class="o">=&gt;</span> <span class="n">phone_number</span>
    <span class="k">rescue</span> <span class="o">=&gt;</span> <span class="n">err</span>
      <span class="nb">puts</span> <span class="n">err</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="nf">backtrace</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">thanks!</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">{})</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:phone_number</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">phone_number</span><span class="p">.</span><span class="nf">amount_of_correct_answers</span> <span class="o">==</span> <span class="no">VoteQuestion</span><span class="p">.</span><span class="nf">count</span> <span class="k">then</span>
      <span class="n">playback</span> <span class="s1">'Goodbye'</span>
    <span class="k">else</span>
      <span class="n">phone_number</span><span class="p">.</span><span class="nf">question_number</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">phone_number</span><span class="p">.</span><span class="nf">amount_of_asked_questions</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">phone_number</span><span class="p">.</span><span class="nf">amount_of_correct_answers</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">phone_number</span><span class="p">.</span><span class="nf">save</span>
      <span class="n">playback</span> <span class="s1">'Goodbye_wrong'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="nb">trap</span><span class="p">(</span><span class="s1">'INT'</span><span class="p">)</span>   <span class="p">{</span> <span class="no">AGIServer</span><span class="p">.</span><span class="nf">shutdown</span> <span class="p">}</span>
<span class="nb">trap</span><span class="p">(</span><span class="s1">'TERM'</span><span class="p">)</span>   <span class="p">{</span> <span class="no">AGIServer</span><span class="p">.</span><span class="nf">shutdown</span> <span class="p">}</span>

<span class="k">begin</span>
  <span class="n">config</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:bind_port</span> <span class="o">=&gt;</span> <span class="mi">4574</span><span class="p">,</span>
    <span class="ss">:min_workers</span> <span class="o">=&gt;</span> <span class="mi">5</span><span class="p">,</span>
    <span class="ss">:max_workers</span> <span class="o">=&gt;</span> <span class="mi">12</span><span class="p">,</span>
    <span class="ss">:jobs_per_worker</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
    <span class="ss">:stats</span> <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
    <span class="ss">:bind_host</span> <span class="o">=&gt;</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span>
    <span class="ss">:logger</span> <span class="o">=&gt;</span> <span class="n">logger</span>
  <span class="p">}</span>
  <span class="no">AgiServer</span> <span class="o">=</span> <span class="no">AGIServer</span><span class="p">.</span><span class="nf">new</span> <span class="n">config</span>
<span class="k">rescue</span> <span class="no">Errno</span><span class="o">::</span><span class="no">EADDRINUSE</span>
  <span class="n">error</span> <span class="o">=</span> <span class="s2">"Cannot start AGI Server, address already in use."</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">fatal</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
  <span class="nb">print</span> <span class="s2">"</span><span class="si">#{</span><span class="n">error</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span>
  <span class="nb">exit</span>
<span class="k">else</span>
  <span class="nb">print</span> <span class="s2">"</span><span class="si">#{</span><span class="vg">$$</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="no">AgiServer</span><span class="p">.</span><span class="nf">start</span>
<span class="no">AgiServer</span><span class="p">.</span><span class="nf">finish</span>
</code></pre></div></div>

<p>Good luck!</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/02/questionnaire-with-asterisk-pbx-agi-ruby.html</guid>
                <description>
                    
                    The Questionnaire application, based on the AsteriskRuby gem, is a production-ready system that was developed a while ago for a small project. Now, I want to share it with the VoIP community. The application provides caller authentication, prompts for a PIN code, and continues from the last unanswered question for returning callers, storing answers and call records in the database.
                    
                </description>
                <pubDate>Tue, 12 Feb 2013 22:29:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Telephony system for remote locations</title>
                <link>//andrius.mobi/2013/02/telephony-system-for-remote-locations.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>Living far from one’s home country, working remotely, frequent travel, or maintaining a presence in another country often necessitates a reliable telecommunication system to stay connected globally.</p>

<h2 id="target-users">Target users</h2>

<ul>
  <li>Remote workers</li>
  <li>Travelers and tourists</li>
  <li>Digital nomads</li>
  <li>Expats, migrants, and students</li>
  <li>International businesses or businesses with multiple branches</li>
  <li>Transport and logistics companies</li>
  <li>Travel agencies</li>
  <li>…and more!</li>
</ul>

<p><strong>These users often seek:</strong></p>

<ul>
  <li>A local SIM card for local calls and internet browsing.</li>
  <li>A way to receive calls on their original (home) phone number without incurring high roaming fees.</li>
  <li>A cost-effective roaming solution.</li>
  <li>A virtual presence with a local phone number in a remote location.</li>
  <li>Low-cost calling options.</li>
</ul>

<h2 id="solution">Solution</h2>

<p>This can be achieved by setting up a phone system with the following components for low-cost or zero-cost calls between locations:</p>

<ul>
  <li><strong>VoIP server:</strong> This could be a hosted PBX or a small server (e.g., an old computer, Raspberry Pi, OpenWRT router, or VPS) running Linux and Asterisk PBX.</li>
  <li><strong>Prepaid SIM card:</strong> For use in the current location.</li>
  <li><strong>DID phone number:</strong> A Direct Inward Dialing (DID) number in the home (or remote, for virtual presence) location. This number, obtained from a VoIP carrier, can be forwarded to your phone system.
  Alternatively, an FXO/VoIP box can connect your home phone line, or a Raspberry Pi with a GSM USB stick/gateway can utilize your old SIM card.</li>
</ul>

<p>Set up call diversion from your home SIM card to the DID number (or keep your SIM card active within the GSM gateway).</p>

<p>Configure a SIP account on your softphone and point it to the VoIP server.</p>

<p>Update the dialplan to start receiving calls effortlessly.</p>

<p>This system supports calls in both directions. If internet coverage is unavailable, calls can be routed to a mobile phone via a VoIP trunk. While this may involve a fee, it is generally more economical than standard roaming charges.</p>

<p>I have personally used this method for years and am currently developing a roaming PBX solution to automate various use cases.</p>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/02/telephony-system-for-remote-locations.html</guid>
                <description>
                    
                    How to build a telecommunication system to keep you connected globally while maintaining a good price/quality/flexibility balance. The components include a VoIP server, prepaid SIM card, and DID phone number for low-cost or zero-cost calls.
                    
                </description>
                <pubDate>Tue, 05 Feb 2013 22:00:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
        
            <item>
                <title>Asterisk AGI sample in bash</title>
                <link>//andrius.mobi/2013/02/asterisk-agi-sample-in-bash.html</link>
                <content:encoded>
                    <![CDATA[
                    <p>This post presents an interesting Asterisk AGI sample script written in Bash. Bash is a great alternative in situations where external scripts need to be executed to implement functionality that Asterisk cannot do. Another option is to use the <a href="https://wiki.asterisk.org/wiki/display/AST/Lua+Dialplan+Configuration">Lua dialplan</a>. Personally, I use Ruby for the same purpose, either with <a href="http://adhearsion.com">Adhearsion</a> or <a href="https://rubygems.org/gems/AsteriskRuby">AsteriskRuby</a>.</p>

<p>The AGI script is provided below. It is very basic, but fully functional:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">declare</span> <span class="nt">-a</span> array
<span class="k">while </span><span class="nb">read</span> <span class="nt">-e</span> ARG <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$ARG</span><span class="s2">"</span> <span class="o">]</span> <span class="p">;</span> <span class="k">do
        </span><span class="nv">array</span><span class="o">=(</span><span class="sb">`</span> <span class="nb">echo</span> <span class="nv">$ARG</span> | <span class="nb">sed</span> <span class="nt">-e</span> <span class="s1">'s/://'</span><span class="sb">`</span><span class="o">)</span>
        <span class="nb">export</span> <span class="k">${</span><span class="nv">array</span><span class="p">[0]</span><span class="k">}</span><span class="o">=</span><span class="k">${</span><span class="nv">array</span><span class="p">[1]</span><span class="k">}</span>
<span class="k">done</span>

<span class="c"># The following variables are available from Asterisk</span>
<span class="nb">echo</span> <span class="nv">$agi_request</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_channel</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_language</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_type</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_uniqueid</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_callerid</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_dnid</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_rdnis</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_context</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_extension</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_priority</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="nv">$agi_enhanced</span> <span class="o">&gt;</span>&amp;2

checkresults<span class="o">()</span> <span class="o">{</span>
        <span class="k">while </span><span class="nb">read </span>line
        <span class="k">do
        case</span> <span class="k">${</span><span class="nv">line</span>:0:4<span class="k">}</span> <span class="k">in</span>
        <span class="s2">"200 "</span> <span class="p">)</span> <span class="nb">echo</span> <span class="nv">$line</span> <span class="o">&gt;</span>&amp;2
                 <span class="k">return</span><span class="p">;;</span>
        <span class="s2">"510 "</span> <span class="p">)</span> <span class="nb">echo</span> <span class="nv">$line</span> <span class="o">&gt;</span>&amp;2
                 <span class="k">return</span><span class="p">;;</span>
        <span class="s2">"520 "</span> <span class="p">)</span> <span class="nb">echo</span> <span class="nv">$line</span> <span class="o">&gt;</span>&amp;2
                 <span class="k">return</span><span class="p">;;</span>
        <span class="k">*</span>      <span class="p">)</span> <span class="nb">echo</span> <span class="nv">$line</span> <span class="o">&gt;</span>&amp;2<span class="p">;;</span> <span class="c"># Keep reading those invalid command</span>
                                  <span class="c"># command syntax until "520 End ..."</span>
        <span class="k">esac</span>
        <span class="k">done</span>
<span class="o">}</span>

<span class="nv">res</span><span class="o">=</span>&lt;SOME SCRIPT&gt;

<span class="nb">echo</span> <span class="s2">"1.  Setting Variable 'Test Variable' ..."</span> <span class="o">&gt;</span>&amp;2
<span class="nb">echo</span> <span class="s2">"SET VARIABLE TestVariable </span><span class="se">\"</span><span class="nv">$res</span><span class="se">\"</span><span class="s2">"</span>
checkresults

<span class="nb">echo</span> <span class="s2">"=================== Complete ===================="</span> <span class="o">&gt;</span>&amp;2
</code></pre></div></div>

                    ]]>
                </content:encoded>
                <guid isPermaLink="false">/2013/02/asterisk-agi-sample-in-bash.html</guid>
                <description>
                    
                    The Asterisk PBX AGI sample in Bash is a great option for creating small yet flexible dial plans for embedded devices and more.
                    
                </description>
                <pubDate>Sat, 02 Feb 2013 20:29:00 +0000</pubDate>
                <author>Andrius Kairiukstis</author>
            </item>
        
    
  </channel>
</rss>
